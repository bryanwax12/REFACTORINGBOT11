# –ê—É–¥–∏—Ç: "–ò–Ω–æ–≥–¥–∞ —à–∞–≥–∏ –ø—É—Ç–∞—é—Ç—Å—è"

–î–∞—Ç–∞: 2025-01-XX

## ‚úÖ –ß–¢–û –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢

### 1. ‚úÖ Persistence –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- **–°—Ç–∞—Ç—É—Å:** –†–ê–ë–û–¢–ê–ï–¢
- **–§–∞–π–ª:** `/app/backend/server.py`
- **–î–µ—Ç–∞–ª–∏:**
  - `DictPersistence()` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
  - `ConversationHandler` –∏–º–µ–µ—Ç `persistent=True`
  - `ConversationHandler` –∏–º–µ–µ—Ç `name="order_conversation"`

### 2. ‚úÖ –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ handlers –∏—Å–ø–æ–ª—å–∑—É—é—Ç @safe_handler
- **–°—Ç–∞—Ç—É—Å:** –ß–ê–°–¢–ò–ß–ù–û –†–ê–ë–û–¢–ê–ï–¢
- **–ü–æ–∫—Ä—ã—Ç–∏–µ:** 49 –∏–∑ 60 —Ñ—É–Ω–∫—Ü–∏–π (81.6%)
- **–î–µ—Ç–∞–ª–∏:** `@safe_handler` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

---

## ‚ùå –ß–¢–û –ù–£–ñ–ù–û –ò–°–ü–†–ê–í–ò–¢–¨

### 1. ‚ùå 11 —Ñ—É–Ω–∫—Ü–∏–π –ë–ï–ó @safe_handler

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –≤–µ—Ä–Ω—É—Ç—å `None` –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç flow

**–§—É–Ω–∫—Ü–∏–∏ –±–µ–∑ @safe_handler:**

#### –§–∞–π–ª: `payment.py`
- Line 275: `process_payment()`

#### –§–∞–π–ª: `confirmation.py`
- Line 141: `show_edit_menu()`
- Line 168: `handle_data_confirmation()`

#### –§–∞–π–ª: `rates.py`
- Line 28: `fetch_shipping_rates()`

#### –§–∞–π–ª: `skip_handlers.py`
- Line 19: `handle_skip_field()`
- Line 504: `skip_address_validation()`

#### –§–∞–π–ª: `carriers.py`
- Line 16: `select_carrier()`

#### –§–∞–π–ª: `entry_points.py`
- Line 151: `start_order_with_template()`
- Line 201: `return_to_payment_after_topup()`
- Line 360: `order_new()`
- Line 399: `order_from_template_list()`
- Line 453: `continue_order_after_template()`

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `@safe_handler(fallback_state=ConversationHandler.END)` –∫–æ –≤—Å–µ–º

---

### 2. ‚ùå return_to_order –ù–ï –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç state

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** `return_to_order` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π state –∏–∑ –ë–î

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
saved_state = session.get("session_data", {}).get("state_before_cancel")
# ...
return saved_state  # ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ state –≤–∞–ª–∏–¥–Ω—ã–π!
```

**–ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫:**
- State –º–æ–∂–µ—Ç –±—ã—Ç—å corrupted –≤ –ë–î
- State –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ä—ã–º/–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º
- State –º–æ–∂–µ—Ç –±—ã—Ç—å None –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º state

---

### 3. ‚ùå –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö states

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** MEDIUM

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π handler –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –∫–∞–∫–∏–µ states –≤–∞–ª–∏–¥–Ω—ã–µ, –Ω–æ —Å–ø–∏—Å–æ–∫ –Ω–∏–≥–¥–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å `ORDER_FLOW_STATES` –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É

---

### 4. ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** MEDIUM

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–æ–∂–Ω–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—á–µ–º—É —à–∞–≥–∏ –ø—É—Ç–∞—é—Ç—Å—è –±–µ–∑ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤

**–¢–µ–∫—É—â–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
logger.info(f"Restored state from session: {saved_state}")
```

**–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:**
- –û—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –ø–µ—Ä–µ—Ö–æ–¥ (caller)
- –ö—É–¥–∞ –∏–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ (next_state)
- –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ context
- –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å state

---

### 5. ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ @safe_handler –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** LOW

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `cancellation.py:163` –µ—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:
```python
@safe_handler(fallback_state=ConversationHandler.END)
@with_user_session(create_user=False, require_session=True)
@safe_handler(fallback_state=ConversationHandler.END)  # ‚ùå –î–£–ë–õ–ò–ö–ê–¢!
async def return_to_order(...)
```

**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö–†–ò–¢–ò–ß–ù–û):
- [ ] –î–æ–±–∞–≤–∏—Ç—å @safe_handler –∫ 11 —Ñ—É–Ω–∫—Ü–∏—è–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é state –≤ return_to_order
- [ ] –°–æ–∑–¥–∞—Ç—å ORDER_FLOW_STATES –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É
- [ ] –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ @safe_handler –≤ return_to_order

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–ê–ñ–ù–û):
- [ ] –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- [ ] –°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é validate_state()
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ @safe_handler –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–ï–õ–ê–¢–ï–õ–¨–ù–û):
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É states
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã

---

## üéØ –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–∞–ª–∏–¥–Ω—ã—Ö states
**–§–∞–π–ª:** `backend/server.py` –∏–ª–∏ `backend/handlers/order_flow/states.py`

```python
# –í—Å–µ –≤–∞–ª–∏–¥–Ω—ã–µ states –¥–ª—è order flow
ORDER_FLOW_STATES = [
    FROM_NAME, FROM_ADDRESS, FROM_ADDRESS2, FROM_CITY, FROM_STATE,
    FROM_ZIP, FROM_PHONE, TO_NAME, TO_ADDRESS, TO_ADDRESS2,
    TO_CITY, TO_STATE, TO_ZIP, TO_PHONE,
    PARCEL_WEIGHT, PARCEL_LENGTH, PARCEL_WIDTH, PARCEL_HEIGHT,
    CALCULATING_RATES, CONFIRM_DATA, SELECT_CARRIER, PAYMENT_METHOD
]
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é
**–§–∞–π–ª:** `backend/utils/state_validation.py`

```python
def validate_state(state, context="unknown"):
    """Validates that state is valid for order flow"""
    if state is None:
        logger.error(f"‚ùå State is None in {context}")
        return False
    
    if state not in ORDER_FLOW_STATES:
        logger.error(f"‚ùå Invalid state {state} in {context}")
        return False
    
    logger.debug(f"‚úÖ State {state} is valid in {context}")
    return True
```

### –®–∞–≥ 3: –£–ª—É—á—à–∏—Ç—å return_to_order
**–§–∞–π–ª:** `backend/handlers/order_flow/cancellation.py`

–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º state:
```python
# Validate state before returning
if saved_state:
    if validate_state(saved_state, "return_to_order"):
        logger.info(f"‚úÖ Returning to valid state: {saved_state}")
        return saved_state
    else:
        logger.warning(f"‚ö†Ô∏è Invalid state {saved_state}, falling back to FROM_NAME")
        saved_state = None

# If no valid state, return to FROM_NAME
if not saved_state:
    logger.info("üîÑ No valid state, returning to FROM_NAME")
    return FROM_NAME
```

### –®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å @safe_handler –∫ 11 —Ñ—É–Ω–∫—Ü–∏—è–º
–î–æ–±–∞–≤–∏—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∫ –∫–∞–∂–¥–æ–π –∏–∑ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

### –®–∞–≥ 5: –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
–í `cancellation.py:163` –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω `@safe_handler`

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –¢–µ—Å—Ç 1: –ù–æ—Ä–º–∞–ª—å–Ω—ã–π flow
- –ù–∞—á–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –ü—Ä–æ–π—Ç–∏ –≤—Å–µ —à–∞–≥–∏ ‚Üí –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å ‚úÖ

### –¢–µ—Å—Ç 2: –í–æ–∑–≤—Ä–∞—Ç –∏–∑ –æ—Ç–º–µ–Ω—ã
- –ù–∞—á–∞—Ç—å –∑–∞–∫–∞–∑ ‚Üí –ó–∞–ø–æ–ª–Ω–∏—Ç—å 3 —à–∞–≥–∞ ‚Üí –û—Ç–º–µ–Ω–∞ ‚Üí –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–∫–∞–∑—É
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —à–∞–≥ ‚úÖ

### –¢–µ—Å—Ç 3: –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –í–≤–µ—Å—Ç–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí **–û–∂–∏–¥–∞–µ—Ç—Å—è:** –û—Å—Ç–∞—Ç—å—Å—è –Ω–∞ —Ç–æ–º –∂–µ —à–∞–≥–µ ‚úÖ

### –¢–µ—Å—Ç 4: Corrupted state –≤ –ë–î
- –í—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π state –≤ –ë–î ‚Üí –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤–µ—Ä–Ω—É—Ç—å—Å—è
- **–û–∂–∏–¥–∞–µ—Ç—Å—è:** Fallback to FROM_NAME ‚úÖ

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- –®–∞–≥–∏ –∏–Ω–æ–≥–¥–∞ –ø—É—Ç–∞—é—Ç—Å—è ‚ùå
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –±–æ—Ç —Ç–µ—Ä—è–µ—Ç—Å—è ‚ùå
- –í–æ–∑–≤—Ä–∞—Ç –∏–∑ –æ—Ç–º–µ–Ω—ã —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ ‚ùå

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è ‚úÖ
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚úÖ
- –í–æ–∑–≤—Ä–∞—Ç –∏–∑ –æ—Ç–º–µ–Ω—ã —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ ‚úÖ
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ ‚úÖ

---

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 1-2 —á–∞—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** HIGH
