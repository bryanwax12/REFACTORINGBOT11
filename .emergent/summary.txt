<analysis>**original_problem_statement:**
Изначально задача состояла в рефакторинге и аудите Telegram-бота. После архитектурного рефакторинга возникли множественные ошибки. Пользователь поставил следующие задачи:
1.  Исправить критический баг в функции редактирования шаблонов.
2.  Устранить зависания бота.
3.  Исправить UI/UX в боте и админ-панели.
4.  Решить проблемы с пополнением баланса через Oxapay (вебхуки).
5.  Устранить критические ошибки , , .
6.  Решить проблему с истечением сессии пользователя.
7.  Провести очистку кода, линтинг и нагрузочное тестирование.
8.  Починить неработающие кнопки в админ-панели (, , , , , , ).
9.  Создать новую функцию: система запроса возврата средств (рефанда) за лейблы старше 5 дней, с UI в боте и админ-панели.
10. Убедиться, что состояния пользователей не пересекаются под нагрузкой.
11. Исправить неработающие уведомления при изменении баланса из админки.
12. Удалить ненужные элементы интерфейса (, ).
13. Реализовать загрузку файлов для рассылок.

PRODUCT REQUIREMENTS:
1.  **Стабильность**: Основной флоу Telegram-бота и админки должен работать без ошибок, зависаний и сбоев.
2.  **Надежность платежей**: Флоу пополнения баланса и обработка вебхуков должны быть полностью автоматическими.
3.  **Качество кода**: Код должен быть модульным, чистым, без мертвого кода, хардкода и ошибок линтера, с правильными индексами БД.
4.  **UX**: Интерфейс бота и админ-панели должен быть интуитивно понятным, без визуальных багов и с корректным отображением информации. Уведомления должны быть информативными и красивыми.
5.  **Изоляция пользователей**: Состояния (шаги диалога) разных пользователей не должны пересекаться даже при одновременной работе.

**User's preferred language**: Русский

**what currently exists?**
Агент стабилизировал приложение, исправив множество критических ошибок. Была отлажена и исправлена функция рассылки (включая рассылку с изображениями), проведена очистка базы данных по запросу пользователя. Агент успешно защитил ключевые административные эндпоинты авторизацией и выполнил линтинг кода, исправив десятки ошибок. Были решены многочисленные проблемы с развертыванием в production (неправильные переменные окружения, неработающий webhook), бот успешно запущен и работает на preview URL. Также исправлены системные ошибки в логике состояний () при отмене заказа, особенно при использовании шаблонов.

**Last working item**:
    - Last item agent was working: Отладка вебхука от Oxapay. Пользователь попросил протестировать платежи. Агент симулировал получение вебхука и обнаружил, что баланс пользователя не обновляется, поскольку система не может найти соответствующий платеж в базе данных.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? backend testing agent. Необходимо симулировать полный цикл: 1. Создать запись о платеже в БД с . 2. Отправить POST-запрос на эндпоинт вебхука, имитирующий данные от Oxapay. 3. Проверить, что баланс пользователя обновился, а статус платежа изменился с  на .
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - Issue 1: (P0) Вебхук от Oxapay не обновляет баланс пользователя.
  - Issue 2: (P1) Production URL недоступен.
  - Issue 3: (P2) Тестовый бот не отображается в админ-панели.
  
  Issues Detail:
  - Issue 1: 
     - Attempted fixes: Агент симулировал получение вебхука и обнаружил, что платеж не находится в БД. Расследование показало, что обработчик ищет платеж по полю , в то время как данные от Oxapay (и созданный для теста платеж) содержат .
     - Next debug checklist: 
        1. Открыть файл .
        2. В функции  изменить логику поиска платежа. Запрос  на строке 47 должен быть изменен, чтобы искать по полю . Более надежным решением будет поиск по , так как именно это поле используется для создания платежа и приходит от Oxapay.
        3. После исправления кода провести тестовую симуляцию: создать платеж и отправить вебхук.
     - Why fix this issue and what will be achieved with the fix? Это критически важная функция для автоматического пополнения баланса пользователей.
     - Status:  IN PROGRESS
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix? backend
     - Blocked on other issue: Нет.
  - Issue 2: 
     - Attempted fixes: Агент подтвердил через , что домен  не резолвится (Could not resolve host). В качестве временного решения бот был успешно настроен и запущен на рабочем preview URL.
     - Next debug checklist: Проблема, скорее всего, не в коде, а в конфигурации развертывания на платформе Emergent. Следующему агенту следует сообщить пользователю, что production-домен не настроен или настроен неверно, и для его активации может потребоваться проверка настроек деплоя на платформе.
     - Why fix this issue and what will be achieved with the fix? Без рабочего production URL приложение не может считаться полностью развернутым в production.
     - Status:  BLOCKED (ожидается действие от пользователя или проверка платформы).
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix? backend (проверка доступности URL).
     - Blocked on other issue: Нет.
  - Issue 3: 
     - Attempted fixes: Не было.
     - Next debug checklist: 
        1. Изучить эндпоинт, который отдает список ботов для админ-панели (вероятно, в  или похожем файле).
        2. Проверить логику в репозитории: есть ли фильтры, которые могут скрывать тестового бота.
        3. Проверить код фронтенда (), чтобы понять, как отображается список.
     - Why fix this issue and what will be achieved with the fix? Выполнение одного из изначальных требований пользователя.
     - Status:  NOT STARTED
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix? both
     - Blocked on other issue: Нет.

**In progress Task List**:
  - Task 1: (P0) Исправление логики обработчика вебхуков Oxapay.
 
 Task Detail:
  - Task 1: 
     - Where to resume: Файл , функция .
     - What will be achieved with this? Автоматическое зачисление средств на баланс пользователей после оплаты.
     - Status:  IN PROGRESS
     - Should Test frontend/backend/both after fix? backend
     - Blocked on something: Нет.

**Upcoming and Future Tasks**
 Upcoming Tasks:
    - (P1) **Финальный аудит безопасности**: Проверить все административные эндпоинты на наличие защиты .
 Future Tasks:
    - (P2) Внедрение кеширования на Redis.
    - (P3) Внедрение структурированного логирования (JSON).
    - (P4) Улучшение CI/CD пайплайна.

**Completed work in this session**
- **Стабилизация рассылок**: Исправлена ошибка, из-за которой рассылки не доходили до пользователей. Добавлена автоматическая пометка пользователей, заблокировавших бота.
- **Исправлена рассылка с изображениями**: Решена проблема с неверным URL изображения и , логика переведена на использование .
- **Очистка данных**: По запросу пользователя из БД были удалены все пользователи, заказы и платежи, кроме одного указанного.
- **Защита эндпоинтов**: Добавлена авторизация по API-ключу на критически важные административные эндпоинты (, , , , ).
- **Линтинг кода**: Проведен полный линтинг бэкенда с помощью , исправлено более 30 ошибок, остальные проанализированы.
- **Решение проблем с Production**: Диагностированы и исправлены неверные переменные окружения (, ). Webhook успешно настроен на рабочий preview URL.
- **Исправление логики состояний**: Устранена системная ошибка с  в , из-за которой бот некорректно возвращался к предыдущему шагу при отмене заказа, особенно при использовании шаблонов.
- **Исправлен баг с **: Отлажена и исправлена проблема с отсутствием номера отслеживания в админ-панели.
- **Созданы документы для пользователя**: Подготовлены файлы , инструкции по настройке и генерации ключей.

**Earlier issues found/mentioned but not fixed**
   - Issue 1: **Тестовый бот не отображается в админ-панели**. Эта задача из первоначального списка так и не была начата.

**Known issue recurrence from previous fork**
  - Issue recurrence in previous fork: .
  - Recurrence count: Возникала несколько раз, была решена путем правильной настройки  на  и отключения .
  - Status: RESOLVED
  Note: Ошибка решена, но может вернуться, если пользователь снова попытается запустить бота в режиме polling или с тем же токеном в другом месте.

**Code Architecture**


**Key Technical Concepts**
- **Отладка Webhook**: Использование  для симуляции входящих вебхуков для проверки логики бэкенда без зависимости от внешнего сервиса.
- **Защита FastAPI**: Применение  для защиты административных эндпоинтов.
- **State Management в **: Отладка сложной логики  и . Корневая проблема была найдена в , где  не устанавливался после загрузки шаблона.
- **Конфигурация деплоя**: Различие между  и  средами. Настройка  и . Решение проблемы с неработающим production URL путем переключения на рабочий preview URL.
- **Обработка ошибок Telegram API**: Диагностика и исправление ошибок, таких как ,  и .

**key DB schema**
  - **users**:  (используется для фильтрации в рассылках).
  - **orders**:  (данные теперь корректно мигрируют и сохраняются).
  - **payments**: ,  (ключевые поля для отладки вебхука Oxapay).

**changes in tech stack**
  - Нет изменений в стеке, но произведены значительные исправления в существующем коде.

**All files**
- : **Текущий файл в работе**. Содержит ошибку в логике поиска платежа.
- : **Ключевое исправление**. Найдена и исправлена корневая причина бага с потерей состояния () после использования шаблона.
- : Значительно переработан для исправления рассылок, в том числе с изображениями (переход на ).
-  (bot.py, maintenance.py, settings.py, upload.py): Добавлена недостающая авторизация.
- : Исправлена глобальная ошибка  при обработке ошибок.
- : Новый скрипт для очистки базы данных по запросу пользователя.

**Areas that need refactoring**:
- **Циклические импорты**: В коде много импортов внутри функций для избежания циклических зависимостей. Это приводит к большому количеству ошибок  при линтинге и усложняет чтение кода. В будущем стоит рассмотреть рефакторинг структуры проекта для их устранения.

**key api endpoints**
-  (POST): Эндпоинт для приема вебхуков от Oxapay. **Сейчас находится в отладке.**
-  (POST): Эндпоинт для рассылок, теперь работает корректно с текстом и изображениями (через ).
-  (POST): Загружает изображение, отправляет его ботом самому себе (админу) для получения  и возвращает этот ID.

**Critical Info for New Agent**
- **Приоритет №1**: Исправить вебхук Oxapay. Проблема в файле  на строке 47. Система ищет платеж по , а нужно по .
- **URL для работы**: Бот работает на **preview URL**. Production URL () **недоступен**. Не пытайтесь настроить вебхук на production URL, пока он не заработает. Сообщите пользователю, что это проблема на стороне платформы.
- **Состояние кода**: Код содержит множество локальных импортов для обхода циклических зависимостей. Ошибки линтера  (импорт не в начале файла) следует игнорировать.

**documents created in this job**
  - 
  - 
  - 
  - 
  - 
  - 
  - 
  - 
  - 

**Last 5 User Messages and any pending user messages**
 - **User:** ок исправь как хочешь (ok, fix it as you want). **Status:** IN PROGRESS. Пользователь дал согласие на исправление проблемы с Oxapay.
 - **User:** сделай сам тестовый платеж через нее (make a test payment yourself). **Status:** COMPLETED. Агент симулировал платеж и нашел ошибку.
 - **User:** какую ссылку надо вставить на оксапей (what link should I put for oxapay). **Status:** COMPLETED. Агент предоставил правильный URL для вебхука.
 - **User:** cannot access local variable os where it is not associated with a value. **Status:** COMPLETED. Агент исправил ошибку импорта в роутере загрузки.
 - **User:** это происходит когда выбираешь шаблон... (this happens when you choose a template...). **Status:** COMPLETED. Агент нашел и исправил корневую причину проблемы с потерей состояния.

**Project Health Check:**
- **Broken**: Логика обработки вебхуков Oxapay. Баланс пользователей не пополняется автоматически.
- **Mocked**: Нет.
- **Blocked**: Развертывание и работа на production URL заблокированы из-за недоступности домена.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: YES (агент использовал его для анализа проблемы с , что подтвердило системный характер ошибки).
  - Test files created: []
  - Known regressions: Нет.

**Credentials to test flow:**
Ключ для API админки () находится в файле .

**What agent forgot to execute**
- **Отображение тестового бота в админ-панели**: Эта задача из первоначального списка так и не была рассмотрена.</analysis>
