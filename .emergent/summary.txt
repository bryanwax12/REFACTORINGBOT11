<analysis>
The AI engineer's work primarily focused on iteratively enhancing and debugging a Telegram bot application. Initially, significant effort was dedicated to fixing core bot functionalities, such as  management for conversation flow and correcting step numbering. Subsequent work addressed critical integrations, notably ShipStation (for shipping labels) and CryptoBot (for payments). The engineer meticulously refined label creation, rate de-duplication, and robust error handling including admin notifications. A major part of the trajectory involved building out a comprehensive admin panel with features like tracking, refunds, profit and expense monitoring, and a discount system. Security measures, including API key protection and input sanitization, were also implemented. User feedback was crucial, leading to corrections like the ShipEngine company name workaround and dynamic display of multiple labels. The work culminated with ongoing security enhancements and a pending task to update administrator contact details.
</analysis>

<product_requirements>
The application is a Telegram bot for shipping label generation and crypto payments, targeting robust user interaction and administrative oversight. It features user authentication, crypto payment integration (CryptoBot, with planned Heleket), and ShipStation V2 API for labels.

Key user requirements and implemented features:
-   **Shipping**: ShipStation V2 integration, carrier filtering, dynamic rate fetching, de-duplicated shipping rates, and label voiding upon refund. Address validation was removed as not supported by ShipStation V2.
-   **Payments**: CryptoBot integration with custom top-up and multiple cryptocurrencies (BTC, ETH, USDT, LTC). Heleket integration is planned.
-   **UI/UX (Bot)**: Corrected  navigation, consistent step numbering, dynamic prompts, and a functional main menu. Russian localization for bot messages and buttons (–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é).
-   **UI/UX (Admin Panel)**: Comprehensive order management with search (Order ID, Tracking #), refund functionality, label download (proxied), and export to Excel/CSV. Display of user Telegram ID, name, and tracking status (progress bar). Profit tracking (fixed 0/label, deducted on refund). Real-time ShipStation expense tracking with date filters.
-   **Error Handling**: Admin Telegram notifications for critical issues, with Contact Administrator button.
-   **Security**: Admin API Key protection for backend, input sanitization for user inputs, and security logging.
-   **Customization**: Per-user discount system.
-   **Issue Resolution**: Addressed ShipStation company name on labels via a hyphen workaround.
</product_requirements>

<key_technical_concepts>
-   **Full-stack**: React (frontend), FastAPI (backend), MongoDB (database).
-   **Telegram Bot API**:  with .
-   **Payment Gateways**: CryptoBot API (), Heleket (planned).
-   **Shipping API**: ShipStation V2 API ().
-   **Data Validation**: Pydantic for API models.
-   **Security**: API Key authentication, Input Sanitization, Logging.
-   **Environment Config**:  for API keys and URLs.
</key_technical_concepts>

<code_architecture>


-   **/app/backend/server.py**:
    -   **Summary of why this file is important:** Centralizes all backend logic: Telegram bot handlers, FastAPI endpoints for admin panel, database interactions, CryptoBot, and ShipStation integrations.
    -   **Summary of the changes made to this file:**
        -   **Bot Logic**: Fixed  management,  logic, phone number validation, step numbering consistency, removed My Orders and Track Shipment commands/buttons, added Russian button text (–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é).
        -   **ShipStation**: Removed V2 address validation, corrected label creation status to 200, de-duplicated rates, added API for voiding labels and tracking status. Applied - as  workaround.
        -   **Admin API**: Added endpoints for  (search, export, multiple label display), ,  (profit, expenses), .
        -   **Models**: Updated  (added ),  (added ),  (added ).
        -   **Security**: Implemented  middleware for admin routes, , and  for input sanitization.
        -   **Heleket**: Initial API research and playbook integration preparatory steps.
-   **/app/backend/.env**:
    -   **Summary of why this file is important:** Stores environment variables critical for backend operation, including API keys (ShipStation, CryptoBot, Heleket), database connection string, and Telegram bot token.
    -   **Summary of the changes made to this file:**  (for error notifications),  (updated multiple times for production and sandbox),  (added for backend security), placeholders for Heleket API keys (Merchant ID, Payment API Key, Payout API Key, Webhook Secret).
-   **/app/backend/requirements.txt**:
    -   **Summary of why this file is important:** Lists Python dependencies for the backend.
    -   **Summary of the changes made to this file:** Implied updates for , , , To use the fastapi command, please install "fastapi[standard]":

	pip install "fastapi[standard]", , , , , , . Specific additions for security components like  from  module.
-   **/app/frontend/.env**:
    -   **Summary of why this file is important:** Stores environment variables for the frontend, primarily the backend URL and admin API key for authentication.
    -   **Summary of the changes made to this file:**  and  (added for admin panel security).
-   **/app/frontend/src/App.js**:
    -   **Summary of why this file is important:** The main React component, handling routing, global state, fetching data for dashboard statistics, and managing UI elements.
    -   **Summary of the changes made to this file:** Integrated new  and  cards, updated API calls to include  in headers, and managed state for new modals ().
-   **/app/frontend/src/components/OrdersTab.jsx**:
    -   **Summary of why this file is important:** Displays the list of orders in the admin panel, including tracking, download, and refund actions.
    -   **Summary of the changes made to this file:** Updated table structure to show user info (name, Telegram ID), display multiple labels per order, integrated tracking status progress bar, and updated buttons for  (using proxy endpoint) and .
-   **/app/frontend/src/components/UsersTab.jsx**:
    -   **Summary of why this file is important:** Displays a list of users in the admin panel.
    -   **Summary of the changes made to this file:** Added a üéÅ Discount button for each user and logic to trigger the . Displays user's current discount percentage.
-   **/app/frontend/src/components/Dashboard.jsx**:
    -   **Summary of why this file is important:** Orchestrates the overall admin panel layout and includes various statistics cards and tabs.
    -   **Summary of the changes made to this file:** Integrated new UI components for profit tracking (), expense tracking (), and modals (, , ).
-   **/app/frontend/src/components/refundModal.jsx**:
    -   **Summary of why this file is important:** Handles the UI for initiating a refund for an order.
    -   **Summary of the changes made to this file:** Updated to support the refund API call.
-   **/app/frontend/src/components/TrackingModal.jsx**:
    -   **Summary of why this file is important:** Displays detailed tracking information for a selected label.
    -   **Summary of the changes made to this file:** Updated to fetch and display detailed tracking status from the backend API.
-   **/app/frontend/src/components/ExpenseInfo.jsx**:
    -   **Summary of why this file is important:** New component to display ShipStation expense statistics.
    -   **Summary of the changes made to this file:** Created to show total/daily expenses and average cost per label, including date range filters.
-   **/app/frontend/src/components/DiscountModal.jsx**:
    -   **Summary of why this file is important:** New component to allow setting discounts for individual users.
    -   **Summary of the changes made to this file:** Created to provide an input field for setting a user's discount percentage and trigger the backend API.
</code_architecture>

<pending_tasks>
-   **Heleket Integration**: The integration playbook for Heleket was retrieved, and the bot verification code  was added to the bot description via BotFather. However, the actual implementation of payment processing with Heleket is pending, awaiting the user to provide the correct , , , and  after a 24-hour waiting period for generation.
-   **Admin Telegram ID Update**: The user requested to change the  used for error notifications and to check other usages. This task is currently in progress.
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was implementing security enhancements for the application. This included:
1.  **Admin API Key Protection**: An  was added to  and a FastAPI  middleware () was implemented in  to secure all admin-related API endpoints (e.g., , , , , ). The frontend (, ) was updated to include this API key in  headers for all backend calls.
2.  **Input Sanitization**:  was applied to user inputs in  and  functions in  to prevent potential injection attacks.
3.  **Security Logging**: A  was added to  to log requests, enhancing traceability and security monitoring.

The very last user request was to change the  used for error notifications and to investigate its other usages within the codebase. The AI engineer's last action was to start searching for all occurrences of .
</current_work>

<optional_next_step>
Find all occurrences of  in the codebase, then ask the user for the new ID to update it.
</optional_next_step>
