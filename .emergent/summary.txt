<analysis>
The AI engineer's trajectory details extensive work on a Telegram bot and its admin panel. Initially, the focus was on stabilizing core features like Oxapay payments and ShipStation integration, fixing critical bugs, and refining UI/UX. A major development cycle involved implementing a Templates feature, which required significant debugging around  states and data handling. Subsequent efforts addressed user requests for channel invitation functionalities within the admin panel, including individual/mass invitations, tracking channel membership, and preventing messages to blocked or already-subscribed users. The bot's UI was enhanced with a Telegram Menu Button. The latest major feature added was a Broadcast tab in the admin panel, enabling rich text (Markdown) and image broadcasting to all bot users, involving a file upload endpoint and error handling. Throughout the process, the AI debugged numerous frontend (React) and backend (FastAPI, ) issues, often related to state management, API key handling, and data serialization.
</analysis>

<product_requirements>
The core product is a Telegram bot for shipping label generation and crypto payments, managed via an admin panel.
**Core Features:**
*   **Shipping:** ShipStation V2 integration, dynamic rate fetching, parcel dimension input (default 10x10x10 inches, mandatory for >10lb), and address validation (proposed).
*   **Payments:** Oxapay integration, custom top-up amounts (min 0), multiple cryptocurrencies, exact payment required (2% tolerance). Explicit Oxapay mentions removed from bot.
*   **Bot UI/UX:** Multilingual (Russian), consistent navigation, dynamic prompts, functional main menu (My Templates, New Order, Refresh Rates, Contact Administrator), and Telegram Menu Button.
*   **Admin Panel UI/UX:** Order management (search, refund, label download), user details, profit/expense tracking, per-user discount, Create Label form. New Top-ups tab for payment history. User management with Block/Unblock, Invite to Channel, Invite All, Check Channel Status, and Check Bot Access. Broadcast tab for rich-text and image messages.
*   **Error Handling:** Admin Telegram notifications for critical issues.
*   **Security:** Admin API Key protection, input sanitization.
*   **Templates:** Users can save/reuse sender/recipient address info (max 10 per user), name, view, use, rename, delete templates.
*   **Channel Integration:** Admin can invite individual or all users to a Telegram channel. Bot tracks channel membership and user blocking status to avoid sending duplicate/unwanted messages.
*   **Broadcast/Mass Messaging:** Admin can send messages with Markdown formatting and images (upload or URL) to all bot users, excluding blocked ones.
</product_requirements>

<key_technical_concepts>
-   **Full-stack:** React (frontend), FastAPI (backend), MongoDB (database).
-   **Telegram Bot API:**  with  for multi-step interactions.
-   **Payment Gateways:** Oxapay API for cryptocurrency payments.
-   **Shipping API:** ShipStation V2 API for shipping label generation.
-   **Data Validation:** Pydantic for API request/response models.
-   **API Key Authentication:** For admin panel and third-party services.
-   **Frontend UI:** Shadcn/ui (implied by component names like Tabs, Button, Card, Input).
</key_technical_concepts>

<code_architecture>


-   **/app/backend/server.py**:
    -   **Summary of why this file is important:** The central backend application. It orchestrates the Telegram bot logic, handles FastAPI endpoints for the admin panel, interacts with MongoDB, and integrates with external APIs like ShipStation and Oxapay.
    -   **Summary of the changes made to this file:**
        -   **Oxapay/Top-ups:**  fixed for headers/ length. Oxapay webhook handler updated for snake_case keys and paid amount.  directly creates invoice, removed explicit Oxapay mentions.
        -   **Templates:** Added  Pydantic model. Implemented , , , , , , , , .  logic refined to correctly set  and restart  at .  updated to use /.  directs to  state. Fixed / keys to / in  and .  configuration for templates was refactored, creating a separate handler for template management.
        -   **Bot UI/UX:**  modified for My Templates button. Refresh Rates button added.  fixed. ‚ùå –û—Ç–º–µ–Ω–∞ buttons added to various steps. –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ button after top-up. Telegram  added programmatically and old  removed.
        -   **Admin Endpoints:** Added .  and .
        -   **Channel Integration:** Added  and  environment variables. New endpoints  for individual invites and  for mass invites. Logic added to skip blocked users and those already in the channel for invitations.
        -   **Broadcast Feature:** Added  endpoint to send messages and/or images to all users. Supports  or .  endpoint for uploading local images to Telegram to get .  and  endpoints to verify if bot is blocked by user.
        -   **Error Handling/Logging:** Enhanced logging for ShipStation rate requests and  failures, specifically for bot was blocked by the user errors.
        -   **Code Quality:** Fixed multiple  and  during template and broadcast implementation.
-   **/app/backend/.env**:
    -   **Summary of why this file is important:** Stores environment variables critical for backend operation.
    -   **Summary of the changes made to this file:** , , and  were added.
-   **/app/backend/requirements.txt**:
    -   **Summary of why this file is important:** Lists Python dependencies for the backend.
    -   **Summary of the changes made to this file:**  was removed.
-   **/app/frontend/src/App.js**:
    -   **Summary of why this file is important:** Main React component for the admin panel, handling routing, state management, and UI rendering for all admin tabs.
    -   **Summary of the changes made to this file:**
        -   **Orders Tab:** Added Weight and Dimensions columns. Label and Refund buttons vertically aligned.
        -   **Top-ups Tab:** Added new tab with table displaying top-up history and statistics ().
        -   **Users Tab:** Added Block/Unblock buttons and  status badge. Aligned buttons. Added Invite to Channel button for individual users and Invite All to Channel button above the table. Display  status. Added Check Status button for individual users and Check All button for mass status updates. Added Bot Blocked status badge. Added Check Bot Access button for individual users. Added  function for mass bot access checks. Displayed  status.
        -   **Broadcast Tab:** Added a new üì¢ Broadcast tab. Implemented  state,  function,  function. Integrated  for live preview. Added buttons for text formatting (bold, italic, link, color), üì∑ Insert Image (URL), ‚¨ÜÔ∏è Upload Image (local file), üëÅÔ∏è Preview toggle. Displays uploaded image preview. Clears inputs after sending.
        -   **State Management:** Introduced states for managing new features (e.g., , , , ).
        -   **Error Handling/UI:** Added  for API failures.  for debugging.
-   **/app/frontend/.env**:
    -   **Summary of why this file is important:** Stores environment variables for the frontend.
    -   **Summary of the changes made to this file:** No explicit changes mentioned.
-   **/app/frontend/src/components/ui/textarea.jsx**:
    -   **Summary of why this file is important:** A UI component for multiline text input (used in Broadcast tab).
    -   **Summary of the changes made to this file:** No explicit changes mentioned, but it's used.
</code_architecture>

<pending_tasks>
-   **Broadcast Tab:** The functionality to check bot blocking status for *all* users (a Check All Bot Access button) was requested by the user (—Å–¥–µ–ª–∞–π –∫–Ω–æ–ø–∫—É —á—Ç–æ –±—ã –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É) and the AI engineer had just started adding the function () in the frontend.
</pending_tasks>

<current_work>
Immediately before this summary, the AI engineer was working on the Broadcast feature within the admin panel, specifically enhancing the ability to manage and send messages. The user requested a button to check the bot blocking status for *all* users, to identify which users have blocked the bot en masse. The AI engineer had just finished adding the  endpoint to the backend () to process this request. The current task is to implement the corresponding frontend logic () in  and integrate the button into the Users tab of the admin panel, to trigger this mass check and update the UI with the results. This will complete the visibility of blocked bot users and allow admin to effectively filter out inactive users for future broadcasts.
</current_work>

<optional_next_step>
Implement the  function in  and add the Check All Bot Access button.
</optional_next_step>
