<analysis>**original_problem_statement:**
–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π –∑–∞–≤–∏—Å–∞–Ω–∏—è Telegram-–±–æ—Ç–∞ –∏–∑-–∑–∞ –ø–æ—Ç–µ—Ä–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è . –ë—ã–ª–æ —Ä–µ—à–µ–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π  –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π  —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º MongoDB. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª —Å–µ—Ä–∏—é –∑–∞–¥–∞—á –ø–æ –ø–æ–ª–Ω–æ–º—É —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –∏ –∞—É–¥–∏—Ç—É –∫–æ–¥–∞, –≤–∫–ª—é—á–∞—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ , –≤—ã–¥–µ–ª–µ–Ω–∏–µ UI-–ª–æ–≥–∏–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É—Å–∏–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

PRODUCT REQUIREMENTS:
1.  **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–π:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π  –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
2.  **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:** –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è  –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏ (services, handlers, utils).
3.  **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ UI –∏ –ª–æ–≥–∏–∫–∏:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–Ω–µ—Å—Ç–∏ UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π –º–æ–¥—É–ª—å .
4.  **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ü–æ–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É unit-—Ç–µ—Å—Ç–∞–º–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏.
5.  **–ú–æ–¥—É–ª—è—Ä–∏–∑–∞—Ü–∏—è:** –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (–¥–æ—Å—Ç–∞–≤–∫–∞, –ø–ª–∞—Ç–µ–∂–∏, —à–∞–±–ª–æ–Ω—ã, –∞–¥–º–∏–Ω–∫–∞) –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –º–æ–¥—É–ª–∏.
6.  **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç –∏ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –≤—Å–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏.
7.  **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î, –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

**what currently exists?** (give crisp summary)
–ü—Ä–æ–µ–∫—Ç –ø—Ä–æ—à–µ–ª —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤ –º–∞—Å—à—Ç–∞–±–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞. –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π  –±—ã–ª —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã, —Ä–æ—É—Ç–µ—Ä—ã –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏. UI-–ª–æ–≥–∏–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞.  –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±—ã–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ –º–æ–¥—É–ª—å–Ω–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø—É. –î–æ–±–∞–≤–ª–µ–Ω—ã Unit-—Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç. –ë—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã MongoDB –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏. –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞. –ë—ã–ª –ø—Ä–æ–≤–µ–¥–µ–Ω –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—è–≤–∏–ª –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –∏ –Ω–∞—á–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞ –ø–æ –∏—Ö —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é.

**Last working item**: (Tell about what agent was working on and its readiness in terms of completion and testing)
    - Last item agent was working: –ê–≥–µ–Ω—Ç –Ω–∞—á–∞–ª –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π. –í –∫–∞—á–µ—Å—Ç–≤–µ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ –±—ã–ª —Å–æ–∑–¥–∞–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ . –°–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –¥–æ–ª–∂–Ω–æ –±—ã–ª–æ —Å—Ç–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤  –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ middleware –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
    - Status: IN PROGRESS
    - Agent Testing Done: N
    - Which testing method agent to use? –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.2, pluggy-1.6.0
rootdir: /app
plugins: cov-7.0.0, asyncio-1.3.0, anyio-4.11.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 0 items

============================ no tests ran in 0.01s =============================) –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ä—É—á–Ω—ã–µ  –∑–∞–ø—Ä–æ—Å—ã –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã middleware.
    - User Testing Done: N

**All Pending/In progress Issue list**: (List down all issues plus pending 
wtmp begins Fri Nov 14 03:24:00 2025 issues (if present) with PRIORITY. This includes issue on which agent was lastly working on and not yet resolved, issues work in progress or pending, issues mentioned by users but not yet resolved,  issues main agent introduced or missed while working. IMPORTANT: Most recent working item that is pending or in progress by default is of HIGHEST priority, ie P0)

  - Issue 1: (P0) –ù–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
  - Issue 2: (P1) –ü–∞–¥–∞—é—â–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã.
  
  Issues Detail:
  - Issue 1: 
     - Attempted fixes: –ë—ã–ª —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª  –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –†–∞–±–æ—Ç–∞ –±—ã–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –¥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.
     - Next debug checklist: 
        1. –û—Ç–∫—Ä—ã—Ç—å  –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç—å, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è, –µ—Å–ª–∏  –Ω–µ –∑–∞–¥–∞–Ω.
        2. –û—Ç–∫—Ä—ã—Ç—å  –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π  middleware –≤ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
        3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –∞—Ç–∞–∫ (rate limiting, input sanitization) –¥–ª—è –≤—Å–µ—Ö API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.
        4. –ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–µ–π –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (dependency) –∏–∑ middleware.
     - Why fix this issue and what will be achieved with the fix? –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, –∑–∞—â–∏—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ –¥—Ä—É–≥–∏—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ –∞—Ç–∞–∫.
     - Status:  IN PROGRESS
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix? backend
     - Blocked on other issue: –ù–µ—Ç.
  - Issue 2: 
     - Attempted fixes: –ê–≥–µ–Ω—Ç –Ω–∞—á–∞–ª –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –ø—É—Ç–∏ –¥–ª—è  –≤ —Ç–µ—Å—Ç–∞—Ö, –Ω–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å. –ë—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –≤ , –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç.
     - Next debug checklist: 
        1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª—ã –≤  (–Ω–∞–ø—Ä–∏–º–µ—Ä, ).
        2. –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è  –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞ .
        3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ  —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–æ–¥—É–ª—å, –æ—Ç–∫—É–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è (—á–∞—Å—Ç–æ —ç—Ç–æ , –∞ –Ω–µ —Å–∞–º ).
     - Why fix this issue and what will be achieved with the fix? –†–∞–±–æ—á–∏–π –Ω–∞–±–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å E2E —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–∏.
     - Status:  IN PROGRESS
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix? backend
     - Blocked on other issue: –ù–µ—Ç.

**In progress Task List**: (Tasks that were started but were not finished)
  - Task 1: (P0) –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Security Hardening).

 Task Detail:
  - Task 1: 
     - Where to resume: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ middleware –∏–∑  –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è  –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π.
     - What will be achieved with this? –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ, –≥–æ—Ç–æ–≤–æ–µ –∫ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –¥–æ—Å—Ç—É–ø–æ–º.
     - Status:  IN PROGRESS
     - Should Test frontend/backend/both after fix? backend
     - Blocked on something: –ù–µ—Ç.

**Upcoming and Future Tasks**
 Upcoming Tasks:
    - (P1) **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞ .
    - (P2) **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Telegram) –∏–∑  –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Grafana.

 Future Tasks:
    - (P3) **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** –û–±–Ω–æ–≤–∏—Ç—å  –∏  –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –≤–∫–ª—é—á–∞—è –º–æ–¥—É–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

**Completed work in this session**
- **Unit-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–π–¥–µ–Ω—ã –≤—Å–µ 101 unit-—Ç–µ—Å—Ç–∞.
- **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ :** –õ–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–Ω–µ—Å–µ–Ω–∞ –∏–∑  –≤ –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É .
- **–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è :** –£—Å—Ç—Ä–∞–Ω–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç–∞–≤–∫–∏.
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π MongoDB.
- **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:** –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è –∞–¥–º–∏–Ω–∫–∞ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –Ω–∞ –º–æ–¥—É–ª—å–Ω—É—é —Å–µ—Ä–≤–∏—Å-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏.
- **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É:** –°–æ–∑–¥–∞–Ω—ã API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (, ) –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Grafana.
- **–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –ü—Ä–æ–≤–µ–¥–µ–Ω –∞—É–¥–∏—Ç, –≤—ã—è–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏.

**Earlier issues found/mentioned but not fixed**
   - Issue 1: –ü–∞–¥–∞—é—â–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏–∑-–∑–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è  –¥–ª—è  —Ñ—É–Ω–∫—Ü–∏–π –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π –¥–ª—è . –†–∞–±–æ—Ç–∞ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –Ω–∞—á–∞—Ç–∞, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.

**Known issue recurrence from previous fork**
  - –ù–µ—Ç.

**Code Architecture**


**Key Technical Concepts**
- **Security Hardening:** –í–Ω–µ–¥—Ä–µ–Ω–∏–µ middleware –¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
- **Modular Refactoring:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω, –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–π –∫–æ –≤—Å–µ–º –∫–ª—é—á–µ–≤—ã–º —á–∞—Å—Ç—è–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∞–¥–º–∏–Ω–∫–∞, ).
- **Integration Testing (Pytest):** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ E2E —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º , , –∏ .
- **API Monitoring:** –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫.

**key DB schema**
  - –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è , ,  –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

**changes in tech stack**
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å  –¥–ª—è —Å–±–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫.

**All files** (list a.) all created or updated files in this session and why do they exists?  2. Any other important files)
- **–°–æ–∑–¥–∞–Ω—ã (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å):**
  - : –î–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
- **–°–æ–∑–¥–∞–Ω—ã –∏ –∏–∑–º–µ–Ω–µ–Ω—ã (–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞–¥–º–∏–Ω–∫–∏):**
  - : –ù–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ª–æ–≥–∏–∫–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.
  - : –ù–æ–≤—ã–µ –º–æ–¥—É–ª—å–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã –¥–ª—è API –∞–¥–º–∏–Ω–∫–∏.
  - : Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
- **–°–æ–∑–¥–∞–Ω—ã (–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥):**
  - : –§–∞–π–ª—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.
  - : –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
  - : API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞.
- **–í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
  - : –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª, –∫—É–¥–∞ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å middleware –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
  - : –°–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —É—è–∑–≤–∏–º–æ—Å—Ç—å, —Ç—Ä–µ–±—É—é—â—É—é –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

**Areas that need refactoring**:
- ** –∏ **: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã –∞–¥–º–∏–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –Ω–æ–≤—É—é –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –µ–µ –∑–∞—â–∏—Ç—ã.
- ****: –í—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–æ–≤.

**Critical Info for New Agent**
- **–ì–ª–∞–≤–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (P0): –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.** –ù–∞—á–Ω–∏—Ç–µ —Å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ , –≥–¥–µ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ API –∫–ª—é—á–∞. –°—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ middleware –∏–∑  –≤  –¥–ª—è –∑–∞—â–∏—Ç—ã –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.
- **–°–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (P1): –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.** –ü–æ—Å–ª–µ —É—Å–∏–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∏—Å–ø—Ä–∞–≤–∏–≤ –ø–∞–¥–∞—é—â–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã. –û—Å–Ω–æ–≤–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª–∏—Ç–µ –∑–∞–º–µ–Ω–µ  –Ω–∞  –∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—É—Ç–µ–π –¥–ª—è .
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ Redis:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª, —á—Ç–æ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ. –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –µ–≥–æ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á.
- **–Ø–∑—ã–∫ –æ–±—â–µ–Ω–∏—è:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—â–∞–µ—Ç—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –í—Å—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, –ø–ª–∞–Ω—ã –∏ –æ—Ç—á–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º.

**documents created in this job**
  - 
  - 
  - 
  - 
  - 
  - 

**Last 5 User Messages and any pending user messages**
- **User:**  (–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –° –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∞–¥–º–∏–Ω–∫–∏) - **Status:** COMPLETED.
- **User:**  - **Status:** IN PROGRESS (–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª–∞ –∞—É–¥–∏—Ç –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏).
- **User:**  (–£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ B –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —É—Å–∏–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏) - **Status:** IN PROGRESS.
- **User:**  (–°–¥–µ–ª–∞—Ç—å –≤—Å–µ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–º—É –ø–ª–∞–Ω—É –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π) - **Status:** IN PROGRESS.
- **User:**  (–ö–æ–º–∞–Ω–¥–∞ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏) - **Status:** IN PROGRESS.

**Project Health Check:**
- **Broken:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —á–∞—Å—Ç–∏—á–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
- **Mocked:** Unit –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –º–æ–∫–∏.

**Testing status**
  - Testing agent used after significant changes: NO (–∞–≥–µ–Ω—Ç –∑–∞–ø—É—Å–∫–∞–ª —Ç–µ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ ============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-8.4.2, pluggy-1.6.0
rootdir: /app
plugins: cov-7.0.0, asyncio-1.3.0, anyio-4.11.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 234 items

admin_notification_test.py ...                                           [  1%]
backend/tests/integration/test_order_flow_e2e.py FFFFF...                [  4%]
backend/tests/integration/test_payment_integration.py FFFF.FF.           [  8%]
backend/tests/integration/test_simple_integration.py .F..FFFFF...        [ 13%]
backend/tests/integration/test_webhook_integration.py ..F.FFFF           [ 16%]
backend/tests/test_admin_services.py ............                        [ 21%]
backend/tests/test_payment_service.py ......................             [ 31%]
backend/tests/test_refactoring_handlers.py ....                          [ 32%]
backend/tests/test_session_manager.py FFFFFFF                            [ 35%]
backend/tests/test_shipping_service.py .......................           [ 45%]
backend/tests/test_template_service.py ..................                [ 53%]
backend/tests/test_ui_components.py ...........................          [ 64%]
backend_test.py ........................................................ [ 88%]
........                                                                 [ 92%]
return_to_order_test.py ..                                               [ 93%]
telegram_bot_test.py .....                                               [ 95%]
telegram_persistence_test.py ......                                      [ 97%]
template_test.py FF..                                                    [ 99%]
test_admin_notification_direct.py F                                      [100%]

=================================== FAILURES ===================================
__________________ TestOrderFlowE2E.test_new_order_flow_basic __________________

self = <test_order_flow_e2e.TestOrderFlowE2E object at 0xfc24030633d0>
mock_update_callback = <MagicMock spec='Update' id='277231579314512'>
mock_context = <MagicMock spec='_GenericAlias' id='277231585723344'>
test_db = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.3.1', platform='asyncio')), 'telegram_shipping_bot'))

    async def test_new_order_flow_basic(
        self,
        mock_update_callback,
        mock_context,
        test_db
    ):
        """
        Test basic order flow: new_order -> addresses -> parcel -> rates
        """
        from handlers.order_flow.entry_points import new_order_start
        from handlers.order_flow.from_address import order_from_name
        from server import FROM_NAME, FROM_ADDRESS
    
        # Setup: User starts new order
        mock_update_callback.callback_query.data = "new_order"
    
        # Mock database operations
        with patch('server.find_user_by_telegram_id') as mock_find_user, \
             patch('server.count_user_templates', return_value=0), \
             patch('server.check_maintenance_mode', return_value=False), \
             patch('server.check_user_blocked', return_value=False), \
             patch('server.session_manager') as mock_session:
    
            mock_find_user.return_value = {
                "id": "user123",
                "telegram_id": 123456789,
                "balance": 100.0
            }
    
            mock_session.get_or_create_session = AsyncMock(return_value={
                "user_id": 123456789,
                "current_step": "START",
                "temp_data": {}
            })
    
            # Step 1: Start new order
            result = await new_order_start(mock_update_callback, mock_context)
    
            # Verify: Should transition to FROM_NAME state
            assert result == FROM_NAME
            assert mock_update_callback.callback_query.answer.called
    
        # Step 2: Enter from_name
        mock_update_message = MagicMock()
        mock_update_message.message = MagicMock()
        mock_update_message.message.text = "John Doe"
        mock_update_message.message.reply_text = AsyncMock()
        mock_update_message.effective_user = mock_update_callback.effective_user
    
        with patch('server.safe_telegram_call') as mock_safe_call, \
             patch('server.session_manager') as mock_session:
    
            mock_safe_call.side_effect = lambda x: x
            mock_session.update_session = AsyncMock()
    
>           result = await order_from_name(mock_update_message, mock_context)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

backend/tests/integration/test_order_flow_e2e.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/utils/decorators.py:38: in wrapper
    return await func(update, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

update = <MagicMock id='277231572940752'>
context = <MagicMock spec='_GenericAlias' id='277231585723344'>

    @with_typing_indicator
    async def order_from_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Step 1/13: Collect sender name"""
        from server import session_manager, SecurityLogger, sanitize_string, FROM_NAME, FROM_ADDRESS, STATE_NAMES
    
        logger.info(f"üîµ order_from_name - User: {update.effective_user.id}")
    
        # Skip if user is in topup flow
        if context.user_data.get('awaiting_topup_amount'):
            logger.info("‚è≠Ô∏è Skipping - user in topup flow")
            return ConversationHandler.END
    
        name = update.message.text.strip()
        name = sanitize_string(name, max_length=50)
    
        # Validate using centralized validator
        is_valid, error_msg = validate_name(name)
        if not is_valid:
            await safe_telegram_call(update.message.reply_text(error_msg))
            return FROM_NAME
    
        # Store in session AND context
        user_id = update.effective_user.id
        context.user_data['from_name'] = name
>       await session_manager.update_session_atomic(user_id, step="FROM_ADDRESS", data={'from_name': name})
E       TypeError: object MagicMock can't be used in 'await' expression

backend/handlers/order_flow/from_address.py:56: TypeError
----------------------------- Captured stdout call -----------------------------
üîµ PREVIEW DATABASE: telegram_shipping_bot
üîµ PREVIEW BOT SELECTED: @whitelabel_shipping_bot_test_bot
__________________ TestOrderFlowE2E.test_template_order_flow ___________________

self = <test_order_flow_e2e.TestOrderFlowE2E object at 0xfc2403063dd0>
mock_update_callback = <MagicMock spec='Update' id='277231572312080'>
mock_context = <MagicMock spec='_GenericAlias' id='277231568621712'>
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}

    async def test_template_order_flow(
        self,
        mock_update_callback,
        mock_context,
        sample_order_data
    ):
        """
        Test order creation from template
        """
        from handlers.order_flow.entry_points import start_order_with_template
        from server import PARCEL_WEIGHT
    
        # Setup: Load template data into context
        mock_context.user_data.update(sample_order_data)
        mock_context.user_data['template_name'] = "Test Template"
    
        with patch('server.safe_telegram_call') as mock_safe_call:
            mock_safe_call.side_effect = lambda x: x
    
            # Start order with template
>           result = await start_order_with_template(mock_update_callback, mock_context)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

backend/tests/integration/test_order_flow_e2e.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

update = <MagicMock spec='Update' id='277231572312080'>
context = <MagicMock spec='_GenericAlias' id='277231568621712'>

    async def start_order_with_template(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Start order creation with pre-loaded template data"""
        from server import PARCEL_WEIGHT, STATE_NAMES, safe_telegram_call, mark_message_as_selected
    
        query = update.callback_query
    
        # Clear topup flag to prevent conflict with parcel weight input
        context.user_data['awaiting_topup_amount'] = False
    
        # Template data already loaded in context.user_data
        # Ask for parcel weight (first thing not in template)
        from utils.ui_utils import get_cancel_keyboard
        reply_markup = get_cancel_keyboard()
    
        template_name = context.user_data.get('template_name', '—à–∞–±–ª–æ–Ω')
    
        message_text = f"""üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –ø–æ —à–∞–±–ª–æ–Ω—É \"{template_name}\"
    
    –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—ã–ª–∫–∏:
    
    *–í–µ—Å –ø–æ—Å—ã–ª–∫–∏ –≤ —Ñ—É–Ω—Ç–∞—Ö (lb)*
    –ù–∞–ø—Ä–∏–º–µ—Ä: 5.5"""
    
        # Execute answer and mark selected, then send new message
        await safe_telegram_call(query.answer())
    
        # Mark previous message as selected (blocking)
        asyncio.create_task(mark_message_as_selected(update, context))
    
        # Send new message immediately without waiting for mark_message_as_selected
        bot_msg = await safe_telegram_call(query.message.reply_text(
                message_text,
                reply_markup=reply_markup,
                parse_mode='Markdown'
            ))
>       context.user_data['last_bot_message_id'] = bot_msg.message_id
                                                   ^^^^^^^^^^^^^^^^^^
E       AttributeError: 'coroutine' object has no attribute 'message_id'

backend/handlers/order_flow/entry_points.py:148: AttributeError
___________________ TestOrderFlowE2E.test_cancel_order_flow ____________________

self = <test_order_flow_e2e.TestOrderFlowE2E object at 0xfc240306c790>
mock_update_callback = <MagicMock spec='Update' id='277231573099280'>
mock_context = <MagicMock spec='_GenericAlias' id='277231571515088'>

    async def test_cancel_order_flow(
        self,
        mock_update_callback,
        mock_context
    ):
        """
        Test order cancellation
        """
        from handlers.order_flow.cancellation import cancel_order, confirm_cancel_order
        from server import SELECT_CARRIER, STATE_NAMES
    
        # Setup: User is on rates selection screen
        mock_context.user_data['last_state'] = STATE_NAMES[SELECT_CARRIER]
    
        with patch('server.safe_telegram_call') as mock_safe_call:
            mock_safe_call.side_effect = lambda x: x
    
            # Step 1: User clicks cancel
>           result = await cancel_order(mock_update_callback, mock_context)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

backend/tests/integration/test_order_flow_e2e.py:123: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

update = <MagicMock spec='Update' id='277231573099280'>
context = <MagicMock spec='_GenericAlias' id='277231571515088'>

    async def cancel_order(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Show cancellation confirmation"""
        from server import (
            SELECT_CARRIER, PAYMENT_METHOD, STATE_NAMES,
            safe_telegram_call, mark_message_as_selected
        )
    
        if update.callback_query:
            query = update.callback_query
            await safe_telegram_call(query.answer())
    
        # Mark previous message as selected (remove buttons and add "‚úÖ –í—ã–±—Ä–∞–Ω–æ")
        asyncio.create_task(mark_message_as_selected(update, context))
    
        # Check if we're on shipping rates screen
        last_state = context.user_data.get('last_state')
    
        # Add "Check Data" button only if on shipping rates selection screen
        if last_state == STATE_NAMES[SELECT_CARRIER]:
            keyboard = [
                [InlineKeyboardButton("üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ", callback_data='check_data')],
                [InlineKeyboardButton("‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–∫–∞–∑—É", callback_data='return_to_order')],
                [InlineKeyboardButton("‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑", callback_data='confirm_cancel')]
            ]
        else:
            keyboard = [
                [InlineKeyboardButton("‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–∫–∞–∑—É", callback_data='return_to_order')],
                [InlineKeyboardButton("‚úÖ –î–∞, –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑", callback_data='confirm_cancel')]
            ]
    
        reply_markup = InlineKeyboardMarkup(keyboard)
    
        message_text = "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞?\n\n–í—Å–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã."
    
        bot_msg = await safe_telegram_call(query.message.reply_text(
                message_text,
                reply_markup=reply_markup
            ))
    
        # Save last bot message context for button protection
        if bot_msg:
>           context.user_data['last_bot_message_id'] = bot_msg.message_id
                                                       ^^^^^^^^^^^^^^^^^^
E           AttributeError: 'coroutine' object has no attribute 'message_id'

backend/handlers/order_flow/cancellation.py:54: AttributeError
_________________ TestOrderFlowE2E.test_data_confirmation_flow _________________

self = <test_order_flow_e2e.TestOrderFlowE2E object at 0xfc240306d190>
mock_update_callback = <MagicMock spec='Update' id='277231572364944'>
mock_context = <MagicMock spec='_GenericAlias' id='277231572354512'>
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}

    async def test_data_confirmation_flow(
        self,
        mock_update_callback,
        mock_context,
        sample_order_data
    ):
        """
        Test data confirmation screen
        """
        from handlers.order_flow.confirmation import show_data_confirmation
        from server import CONFIRM_DATA
    
        # Setup: User has entered all data
        mock_context.user_data.update(sample_order_data)
    
        with patch('server.safe_telegram_call') as mock_safe_call, \
             patch('server.session_manager') as mock_session:
    
            mock_safe_call.side_effect = lambda x: x
            mock_session.update_session = AsyncMock()
    
>           result = await show_data_confirmation(mock_update_callback, mock_context)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

backend/tests/integration/test_order_flow_e2e.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

update = <MagicMock spec='Update' id='277231572364944'>
context = <MagicMock spec='_GenericAlias' id='277231572354512'>

    async def show_data_confirmation(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Show summary of entered data with edit option"""
        from server import CONFIRM_DATA
        from utils.ui_utils import DataConfirmationUI
    
        data = context.user_data
    
        # Format the summary message using UI utils
        message = DataConfirmationUI.confirmation_header()
        message += DataConfirmationUI.format_address_section("–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å", data, "from")
        message += DataConfirmationUI.format_address_section("–ü–æ–ª—É—á–∞—Ç–µ–ª—å", data, "to")
        message += DataConfirmationUI.format_parcel_section(data)
    
        # Build keyboard using UI utils
        reply_markup = DataConfirmationUI.build_confirmation_keyboard()
    
        # Save last bot message context for button protection
>       bot_msg = await update.message.reply_text(message, reply_markup=reply_markup, parse_mode='Markdown')
                        ^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'NoneType' object has no attribute 'reply_text'

backend/handlers/order_flow/confirmation.py:29: AttributeError
____________ TestOrderFlowE2E.test_payment_flow_sufficient_balance _____________

self = <test_order_flow_e2e.TestOrderFlowE2E object at 0xfc240306db10>
mock_update_callback = <MagicMock spec='Update' id='277231569398160'>
mock_context = <MagicMock spec='_GenericAlias' id='277231569403344'>
sample_shipping_rate = {'amount': 15.5, 'carrier': 'USPS', 'carrier_name': 'USPS', 'delivery_days': '2-3', ...}

    async def test_payment_flow_sufficient_balance(
        self,
        mock_update_callback,
        mock_context,
        sample_shipping_rate
    ):
        """
        Test payment flow when user has sufficient balance
        """
        from handlers.order_flow.payment import show_payment_methods
        from server import PAYMENT_METHOD
    
        # Setup: User selected a rate
        mock_context.user_data['selected_rate'] = sample_shipping_rate
        mock_context.user_data['final_amount'] = 15.50
    
        with patch('server.find_user_by_telegram_id') as mock_find_user, \
             patch('server.safe_telegram_call') as mock_safe_call:
    
            mock_find_user.return_value = {
                "id": "user123",
                "telegram_id": 123456789,
                "balance": 100.0  # Sufficient balance
            }
            mock_safe_call.side_effect = lambda x: x
    
>           result = await show_payment_methods(mock_update_callback, mock_context)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

backend/tests/integration/test_order_flow_e2e.py:198: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

update = <MagicMock spec='Update' id='277231569398160'>
context = <MagicMock spec='_GenericAlias' id='277231569403344'>

    async def show_payment_methods(update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        Show payment method selection screen
    
        This function is typically called after carrier selection.
        Shows options: Pay from balance, Pay with crypto, Top-up balance
        """
        from server import (
            safe_telegram_call,
            find_user_by_telegram_id,
            PAYMENT_METHOD,
            mark_message_as_selected
        )
        from utils.ui_utils import PaymentFlowUI
        import asyncio
    
        query = update.callback_query
        await safe_telegram_call(query.answer())
    
        # Mark previous message as selected (non-blocking)
        asyncio.create_task(mark_message_as_selected(update, context))
    
        telegram_id = query.from_user.id
        user = await find_user_by_telegram_id(telegram_id)
    
        # Get order amount
        selected_rate = context.user_data.get('selected_rate', {})
        amount = context.user_data.get('final_amount', selected_rate.get('amount', 0))
        balance = user.get('balance', 0.0) if user else 0.0
    
        # Build message
        message = PaymentFlowUI.payment_method_selection(amount, balance)
    
        # Build keyboard
        keyboard = []
    
        if balance >= amount:
            keyboard.append([InlineKeyboardButton(
                f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å –±–∞–ª–∞–Ω—Å–∞ (${balance:.2f})",
                callback_data='pay_from_balance'
            )])
    
        keyboard.append([InlineKeyboardButton(
            "üí∞ –û–ø–ª–∞—Ç–∏—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π",
            callback_data='pay_crypto'
        )])
    
        if balance < amount:
            deficit = amount - balance
            keyboard.append([InlineKeyboardButton(
                f"‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å (–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ${deficit:.2f})",
                callback_data='topup_for_order'
            )])
    
        keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥ –∫ —Ç–∞—Ä–∏—Ñ–∞–º", callback_data='back_to_rates')])
        keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_order')])
    
        reply_markup = InlineKeyboardMarkup(keyboard)
    
        bot_msg = await safe_telegram_call(query.message.reply_text(
            message,
            reply_markup=reply_markup
        ))
    
        if bot_msg:
>           context.user_data['last_bot_message_id'] = bot_msg.message_id
                                                       ^^^^^^^^^^^^^^^^^^
E           AttributeError: 'coroutine' object has no attribute 'message_id'

backend/handlers/order_flow/payment.py:77: AttributeError
____________ TestPaymentIntegration.test_balance_payment_full_flow _____________

self = <test_payment_integration.TestPaymentIntegration object at 0xfc240307d790>
test_db = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.3.1', platform='asyncio')), 'telegram_shipping_bot'))
mock_update_callback = <MagicMock spec='Update' id='277231574058384'>
mock_context = <MagicMock spec='_GenericAlias' id='277231574063504'>
sample_shipping_rate = {'amount': 15.5, 'carrier': 'USPS', 'carrier_name': 'USPS', 'delivery_days': '2-3', ...}
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}

    async def test_balance_payment_full_flow(
        self,
        test_db,
        mock_update_callback,
        mock_context,
        sample_shipping_rate,
        sample_order_data
    ):
        """
        Test complete flow: balance payment -> order creation -> label generation
        """
        from services.payment_service import process_balance_payment
    
        # Setup: User has sufficient balance
        telegram_id = 123456789
        amount = 15.50
    
        # Mock user with balance
        mock_user = {
            "id": "user123",
            "telegram_id": telegram_id,
            "balance": 100.0
        }
    
        mock_context.user_data.update(sample_order_data)
        mock_context.user_data['selected_rate'] = sample_shipping_rate
        mock_context.user_data['final_amount'] = amount
    
>       with patch('services.payment_service.find_user_by_telegram_id', return_value=mock_user) as mock_find, \
             patch('services.payment_service.deduct_balance') as mock_deduct:

backend/tests/integration/test_payment_integration.py:43: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0xfc24017d8510>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'services.payment_service' from '/app/backend/services/payment_service.py'> does not have the attribute 'find_user_by_telegram_id'

/usr/local/lib/python3.11/unittest/mock.py:1419: AttributeError
___________ TestPaymentIntegration.test_insufficient_balance_payment ___________

self = <test_payment_integration.TestPaymentIntegration object at 0xfc240307e150>
mock_update_callback = <MagicMock spec='Update' id='277231570059728'>
mock_context = <MagicMock spec='_GenericAlias' id='277231570066640'>

    async def test_insufficient_balance_payment(
        self,
        mock_update_callback,
        mock_context
    ):
        """
        Test payment flow when user has insufficient balance
        """
        from services.payment_service import validate_payment_amount
    
        telegram_id = 123456789
        amount = 150.0  # More than balance
        user_balance = 100.0
    
        # Validate payment
        valid, error = validate_payment_amount(
            amount=amount,
            user_balance=user_balance
        )
    
        # Verify: Should fail validation
        assert valid is False
>       assert "insufficient" in error.lower()
E       AssertionError: assert 'insufficient' in '‚ùå –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.'
E        +  where '‚ùå –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.' = <built-in method lower of str object at 0xfc2402208ae0>()
E        +    where <built-in method lower of str object at 0xfc2402208ae0> = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.'.lower

backend/tests/integration/test_payment_integration.py:84: AssertionError
_________ TestPaymentIntegration.test_crypto_payment_invoice_creation __________

self = <test_payment_integration.TestPaymentIntegration object at 0xfc240307ead0>
mock_update_callback = <MagicMock spec='Update' id='277231569595856'>
mock_context = <MagicMock spec='_GenericAlias' id='277231569597136'>
mock_oxapay_response = {'message': 'Success', 'payLink': 'https://payment.oxapay.com/test', 'result': 100, 'trackId': 'test_track_id_123'}

    async def test_crypto_payment_invoice_creation(
        self,
        mock_update_callback,
        mock_context,
        mock_oxapay_response
    ):
        """
        Test crypto payment invoice creation
        """
        from server import create_oxapay_invoice
    
        with patch('aiohttp.ClientSession.post') as mock_post:
            mock_response = AsyncMock()
            mock_response.status = 200
            mock_response.json = AsyncMock(return_value=mock_oxapay_response)
            mock_post.return_value.__aenter__.return_value = mock_response
    
>           result = await create_oxapay_invoice(
                amount=25.0,
                order_id="order_123",
                description="Test Order Payment"
            )

backend/tests/integration/test_payment_integration.py:104: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

amount = 25.0, order_id = 'order_123', description = 'Test Order Payment'

    async def create_oxapay_invoice(amount: float, order_id: str, description: str = "Shipping Label Payment"):
        """Create payment invoice via Oxapay"""
        if not OXAPAY_API_KEY:
>           raise HTTPException(status_code=500, detail="Oxapay API key not configured")
E           fastapi.exceptions.HTTPException: 500: Oxapay API key not configured

backend/services/api_services.py:23: HTTPException
____________________ TestPaymentIntegration.test_topup_flow ____________________

self = <test_payment_integration.TestPaymentIntegration object at 0xfc240306e690>
test_db = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.3.1', platform='asyncio')), 'telegram_shipping_bot'))
mock_update_message = <MagicMock spec='Update' id='277231574069072'>
mock_context = <MagicMock spec='_GenericAlias' id='277231574065424'>

    async def test_topup_flow(
        self,
        test_db,
        mock_update_message,
        mock_context
    ):
        """
        Test balance top-up flow
        """
        from handlers.order_flow.template_save import handle_topup_amount
        from services.payment_service import validate_topup_amount
    
        # Step 1: Validate topup amount
        valid, error = validate_topup_amount(50.0)
        assert valid is True
        assert error is None
    
        # Step 2: Test too small amount
        valid, error = validate_topup_amount(5.0)
        assert valid is False
>       assert "minimum" in error.lower()
E       AssertionError: assert 'minimum' in '‚ùå *–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: $10*'
E        +  where '‚ùå *–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: $10*' = <built-in method lower of str object at 0xfc24021b7af0>()
E        +    where <built-in method lower of str object at 0xfc24021b7af0> = '‚ùå *–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: $10*'.lower

backend/tests/integration/test_payment_integration.py:134: AssertionError
__________ TestOrderCreationIntegration.test_complete_order_creation ___________

self = <test_payment_integration.TestOrderCreationIntegration object at 0xfc240307dc10>
test_db = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.3.1', platform='asyncio')), 'telegram_shipping_bot'))
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}
sample_shipping_rate = {'amount': 15.5, 'carrier': 'USPS', 'carrier_name': 'USPS', 'delivery_days': '2-3', ...}

    async def test_complete_order_creation(
        self,
        test_db,
        sample_order_data,
        sample_shipping_rate
    ):
        """
        Test complete order creation flow
        """
        # Setup order data
        order_data = {
            **sample_order_data,
            "selected_rate": sample_shipping_rate,
            "telegram_id": 123456789,
            "payment_method": "balance",
            "amount": 15.50
        }
    
        # Mock order insertion
>       with patch('server.insert_order') as mock_insert:

backend/tests/integration/test_payment_integration.py:186: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <unittest.mock._patch object at 0xfc2401449b10>

    def get_original(self):
        target = self.getter()
        name = self.attribute
    
        original = DEFAULT
        local = False
    
        try:
            original = target.__dict__[name]
        except (AttributeError, KeyError):
            original = getattr(target, name, DEFAULT)
        else:
            local = True
    
        if name in _builtins and isinstance(target, ModuleType):
            self.create = True
    
        if not self.create and original is DEFAULT:
>           raise AttributeError(
                "%s does not have the attribute %r" % (target, name)
            )
E           AttributeError: <module 'server' from '/app/backend/server.py'> does not have the attribute 'insert_order'

/usr/local/lib/python3.11/unittest/mock.py:1419: AttributeError
_______ TestOrderCreationIntegration.test_label_generation_after_payment _______

self = <test_payment_integration.TestOrderCreationIntegration object at 0xfc240307d490>
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}
sample_shipping_rate = {'amount': 15.5, 'carrier': 'USPS', 'carrier_name': 'USPS', 'delivery_days': '2-3', ...}

    async def test_label_generation_after_payment(
        self,
        sample_order_data,
        sample_shipping_rate
    ):
        """
        Test shipping label generation after successful payment
        """
        from services.shipping_service import build_shipstation_label_request
    
        order_data = {
            **sample_order_data,
            "selected_rate": sample_shipping_rate
        }
    
        # Build label request
>       label_request = build_shipstation_label_request(
            order_data=order_data,
            rate_data=sample_shipping_rate
        )
E       TypeError: build_shipstation_label_request() got an unexpected keyword argument 'order_data'

backend/tests/integration/test_payment_integration.py:211: TypeError
________________ TestDatabaseIntegration.test_order_pagination _________________

self = <test_simple_integration.TestDatabaseIntegration object at 0xfc240308e250>
test_db = AsyncIOMotorDatabase(Database(MongoClient(host=['localhost:27017'], document_class=dict, tz_aware=False, connect=False, driver=DriverInfo(name='Motor', version='3.3.1', platform='asyncio')), 'telegram_shipping_bot'))

    async def test_order_pagination(self, test_db):
        """Test order pagination with compound index"""
        from utils.optimized_queries import get_user_orders
    
        telegram_id = 888888888
    
        # Insert test orders
        for i in range(5):
>           await test_db.orders.insert_one({
                "id": f"order_{i}",
                "telegram_id": telegram_id,
                "order_number": f"ORD-{i}",
                "created_at": f"2025-01-0{i+1}T00:00:00Z",
                "payment_status": "paid",
                "amount": 10.0 + i
            })

backend/tests/integration/test_simple_integration.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.11/concurrent/futures/thread.py:58: in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/pymongo/collection.py:671: in insert_one
    self._insert_one(
/root/.venv/lib/python3.11/site-packages/pymongo/collection.py:611: in _insert_one
    self.__database.client._retryable_write(acknowledged, _insert_command, session)
/root/.venv/lib/python3.11/site-packages/pymongo/mongo_client.py:1568: in _retryable_write
    return self._retry_with_session(retryable, func, s, None)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/pymongo/mongo_client.py:1413: in _retry_with_session
    return self._retry_internal(retryable, func, session, bulk)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/pymongo/_csot.py:108: in csot_wrapper
    return func(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/pymongo/mongo_client.py:1460: in _retry_internal
    return func(session, conn, retryable)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/root/.venv/lib/python3.11/site-packages/pymongo/collection.py:609: in _insert_command
    _check_write_command_response(result)
/root/.venv/lib/python3.11/site-packages/pymongo/helpers.py:259: in _check_write_command_response
    _raise_last_write_error(write_errors)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

write_errors = [{'code': 11000, 'errmsg': 'E11000 duplicate key error collection: telegram_shipping_bot.orders index: order_id_1 dup key: { order_id: null }', 'index': 0, 'keyPattern': {'order_id': 1}, ...}]

    def _raise_last_write_error(write_errors: List[Any]) -> NoReturn:
        # If the last batch had multiple errors only report
        # the last error to emulate continue_on_error.
        error = write_errors[-1]
        if error.get("code") == 11000:
>           raise DuplicateKeyError(error.get("errmsg"), 11000, error)
E           pymongo.errors.DuplicateKeyError: E11000 duplicate key error collection: telegram_shipping_bot.orders index: order_id_1 dup key: { order_id: null }, full error: {'index': 0, 'code': 11000, 'errmsg': 'E11000 duplicate key error collection: telegram_shipping_bot.orders index: order_id_1 dup key: { order_id: null }', 'keyPattern': {'order_id': 1}, 'keyValue': {'order_id': None}}

/root/.venv/lib/python3.11/site-packages/pymongo/helpers.py:231: DuplicateKeyError
____________ TestServiceIntegration.test_payment_service_validation ____________

self = <test_simple_integration.TestServiceIntegration object at 0xfc240308fd50>

    async def test_payment_service_validation(self):
        """Test payment amount validation"""
        from services.payment_service import validate_payment_amount, validate_topup_amount
    
        # Valid payment
        valid, error = validate_payment_amount(10.0, 100.0)
        assert valid is True
        assert error is None
    
        # Insufficient balance
        valid, error = validate_payment_amount(150.0, 100.0)
        assert valid is False
>       assert error is not None and "insufficient" in error.lower()
E       AssertionError: assert ('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.' is not None and 'insufficient' in '‚ùå –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.')
E        +  where '‚ùå –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.' = <built-in method lower of str object at 0xfc2402208ae0>()
E        +    where <built-in method lower of str object at 0xfc2402208ae0> = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.'.lower

backend/tests/integration/test_simple_integration.py:138: AssertionError
___________ TestServiceIntegration.test_template_service_validation ____________

self = <test_simple_integration.TestServiceIntegration object at 0xfc2403094590>

    async def test_template_service_validation(self):
        """Test template data validation"""
        from services.template_service import validate_template_data
    
        # Valid template - needs all required fields
        valid_data = {
            "from_name": "John",
            "from_street": "123 Main",
            "from_city": "NY",
            "from_state": "NY",
            "from_zip": "10001",
            "to_name": "Jane",
            "to_street": "456 Oak",
            "to_city": "LA",
            "to_state": "CA",
            "to_zip": "90001"
        }
        valid, error = validate_template_data(valid_data)
>       assert valid is True
E       assert False is True

backend/tests/integration/test_simple_integration.py:171: AssertionError
___________ TestServiceIntegration.test_shipping_service_validation ____________

self = <test_simple_integration.TestServiceIntegration object at 0xfc2403094d90>

    async def test_shipping_service_validation(self):
        """Test shipping address and parcel validation"""
        from services.shipping_service import validate_parcel_data
    
        # Valid parcel
>       valid, error = validate_parcel_data(5.0, 12, 8, 6)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: validate_parcel_data() takes 1 positional argument but 4 were given

backend/tests/integration/test_simple_integration.py:186: TypeError
_____________ TestAPIIntegration.test_shipstation_request_building _____________

self = <test_simple_integration.TestAPIIntegration object at 0xfc2403095890>
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}

    async def test_shipstation_request_building(self, sample_order_data):
        """Test ShipStation API request construction"""
        from services.shipping_service import build_shipstation_rates_request
    
        # Add required weight field
        sample_order_data['parcel_weight'] = 5.5
    
>       request = build_shipstation_rates_request(sample_order_data)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: build_shipstation_rates_request() missing 1 required positional argument: 'carrier_ids'

backend/tests/integration/test_simple_integration.py:212: TypeError
_____________ TestAPIIntegration.test_shipstation_api_call_mocked ______________

self = <test_simple_integration.TestAPIIntegration object at 0xfc240308fa10>
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}
mock_shipstation_response = [{'carrierCode': 'stamps_com', 'carrierName': 'USPS', 'otherCost': 0.0, 'serviceCode': 'usps_priority_mail', ...}, {'carrierCode': 'ups_walleted', 'carrierName': 'UPS', 'otherCost': 0.0, 'serviceCode': 'ups_ground', ...}]

    async def test_shipstation_api_call_mocked(
        self,
        sample_order_data,
        mock_shipstation_response
    ):
        """Test ShipStation API call with mocked response"""
        from services.shipping_service import fetch_rates_from_shipstation, build_shipstation_rates_request
    
>       request = build_shipstation_rates_request(sample_order_data)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: build_shipstation_rates_request() missing 1 required positional argument: 'carrier_ids'

backend/tests/integration/test_simple_integration.py:230: TypeError
____________ TestWebhookIntegration.test_telegram_api_rate_limiting ____________

    async def rate_limited_call():
>       raise RetryAfter(5)  # Retry after 5 seconds
        ^^^^^^^^^^^^^^^^^^^
E       telegram.error.RetryAfter: Flood control exceeded. Retry in 5 seconds

backend/tests/integration/test_webhook_integration.py:89: RetryAfter

During handling of the above exception, another exception occurred:

self = <test_webhook_integration.TestWebhookIntegration object at 0xfc2402543ed0>

    async def test_telegram_api_rate_limiting(self):
        """
        Test that we handle Telegram API rate limits
        """
        from server import safe_telegram_call
        from telegram.error import RetryAfter
    
        # Mock a rate-limited call
        async def rate_limited_call():
            raise RetryAfter(5)  # Retry after 5 seconds
    
        with patch('asyncio.sleep', new_callable=AsyncMock):
            # Should handle rate limit gracefully
            try:
>               result = await safe_telegram_call(rate_limited_call())
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

backend/tests/integration/test_webhook_integration.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/handlers/common_handlers.py:43: in safe_telegram_call
    return await asyncio.wait_for(coro, timeout=timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

fut = <Task finished name='Task-127' coro=<TestWebhookIntegration.test_telegram_api_rate_limiting.<locals>.rate_limited_call...end/tests/integration/test_webhook_integration.py:88> exception=RuntimeError('cannot reuse already awaited coroutine')>
timeout = 10

    async def wait_for(fut, timeout):
        """Wait for the single Future or coroutine to complete, with timeout.
    
        Coroutine will be wrapped in Task.
    
        Returns result of the Future or coroutine.  When a timeout occurs,
        it cancels the task and raises TimeoutError.  To avoid the task
        cancellation, wrap it in shield().
    
        If the wait is cancelled, the task is also cancelled.
    
        This function is a coroutine.
        """
        loop = events.get_running_loop()
    
        if timeout is None:
            return await fut
    
        if timeout <= 0:
            fut = ensure_future(fut, loop=loop)
    
            if fut.done():
                return fut.result()
    
            await _cancel_and_wait(fut, loop=loop)
            try:
                return fut.result()
            except exceptions.CancelledError as exc:
                raise exceptions.TimeoutError() from exc
    
        waiter = loop.create_future()
        timeout_handle = loop.call_later(timeout, _release_waiter, waiter)
        cb = functools.partial(_release_waiter, waiter)
    
        fut = ensure_future(fut, loop=loop)
        fut.add_done_callback(cb)
    
        try:
            # wait until the future completes or the timeout
            try:
                await waiter
            except exceptions.CancelledError:
                if fut.done():
                    return fut.result()
                else:
                    fut.remove_done_callback(cb)
                    # We must ensure that the task is not running
                    # after wait_for() returns.
                    # See https://bugs.python.org/issue32751
                    await _cancel_and_wait(fut, loop=loop)
                    raise
    
            if fut.done():
>               return fut.result()
                       ^^^^^^^^^^^^
E               RuntimeError: cannot reuse already awaited coroutine

/usr/local/lib/python3.11/asyncio/tasks.py:489: RuntimeError
------------------------------ Captured log call -------------------------------
WARNING  handlers.common_handlers:common_handlers.py:41 Telegram rate limit: waiting 5s
_________ TestExternalAPIIntegration.test_shipstation_api_integration __________

self = <test_webhook_integration.TestExternalAPIIntegration object at 0xfc24025513d0>
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}
mock_shipstation_response = [{'carrierCode': 'stamps_com', 'carrierName': 'USPS', 'otherCost': 0.0, 'serviceCode': 'usps_priority_mail', ...}, {'carrierCode': 'ups_walleted', 'carrierName': 'UPS', 'otherCost': 0.0, 'serviceCode': 'ups_ground', ...}]

    async def test_shipstation_api_integration(
        self,
        sample_order_data,
        mock_shipstation_response
    ):
        """
        Test ShipStation API integration with mocked response
        """
        from services.shipping_service import build_shipstation_rates_request, fetch_rates_from_shipstation
    
        # Build request
>       request_data = build_shipstation_rates_request(sample_order_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: build_shipstation_rates_request() missing 1 required positional argument: 'carrier_ids'

backend/tests/integration/test_webhook_integration.py:129: TypeError
__________ TestExternalAPIIntegration.test_oxapay_payment_integration __________

self = <test_webhook_integration.TestExternalAPIIntegration object at 0xfc2402551d10>
mock_oxapay_response = {'message': 'Success', 'payLink': 'https://payment.oxapay.com/test', 'result': 100, 'trackId': 'test_track_id_123'}

    async def test_oxapay_payment_integration(
        self,
        mock_oxapay_response
    ):
        """
        Test Oxapay payment API integration
        """
        from server import create_oxapay_invoice
    
        with patch('aiohttp.ClientSession.post') as mock_post:
            mock_response = AsyncMock()
            mock_response.status = 200
            mock_response.json = AsyncMock(return_value=mock_oxapay_response)
            mock_post.return_value.__aenter__.return_value = mock_response
    
>           result = await create_oxapay_invoice(
                amount=50.0,
                order_id="test_order_123",
                description="Test payment"
            )

backend/tests/integration/test_webhook_integration.py:170: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

amount = 50.0, order_id = 'test_order_123', description = 'Test payment'

    async def create_oxapay_invoice(amount: float, order_id: str, description: str = "Shipping Label Payment"):
        """Create payment invoice via Oxapay"""
        if not OXAPAY_API_KEY:
>           raise HTTPException(status_code=500, detail="Oxapay API key not configured")
E           fastapi.exceptions.HTTPException: 500: Oxapay API key not configured

backend/services/api_services.py:23: HTTPException
_____________ TestExternalAPIIntegration.test_api_timeout_handling _____________

self = <test_webhook_integration.TestExternalAPIIntegration object at 0xfc2402552610>

    async def test_api_timeout_handling(self):
        """
        Test handling of API timeouts
        """
        from services.shipping_service import fetch_rates_from_shipstation
        import asyncio
    
        with patch('aiohttp.ClientSession.post') as mock_post:
            # Simulate timeout
            mock_post.side_effect = asyncio.TimeoutError()
    
>           success, rates, error = await fetch_rates_from_shipstation(
                {},
                api_key="test",
                api_secret="test"
            )
E           TypeError: fetch_rates_from_shipstation() got an unexpected keyword argument 'api_key'

backend/tests/integration/test_webhook_integration.py:192: TypeError
_________ TestExternalAPIIntegration.test_api_error_response_handling __________

self = <test_webhook_integration.TestExternalAPIIntegration object at 0xfc2402552fd0>
sample_order_data = {'from_city': 'New York', 'from_name': 'John Doe', 'from_phone': '1234567890', 'from_state': 'NY', ...}

    async def test_api_error_response_handling(
        self,
        sample_order_data
    ):
        """
        Test handling of API error responses (4xx, 5xx)
        """
        from services.shipping_service import fetch_rates_from_shipstation, build_shipstation_rates_request
    
>       request_data = build_shipstation_rates_request(sample_order_data)
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: build_shipstation_rates_request() missing 1 required positional argument: 'carrier_ids'

backend/tests/integration/test_webhook_integration.py:212: TypeError
________________________ test_get_or_create_session_new ________________________

session_manager = <async_generator object session_manager at 0xfc2401bedd50>

    @pytest.mark.asyncio
    async def test_get_or_create_session_new(session_manager):
        """Test creating a new session"""
        user_id = 12345
    
        # Create new session
>       session = await session_manager.get_or_create_session(user_id, initial_data={'test': 'data'})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'async_generator' object has no attribute 'get_or_create_session'

backend/tests/test_session_manager.py:45: AttributeError
_____________________ test_get_or_create_session_existing ______________________

session_manager = <async_generator object session_manager at 0xfc2402272980>

    @pytest.mark.asyncio
    async def test_get_or_create_session_existing(session_manager):
        """Test getting existing session"""
        user_id = 12345
    
        # Create session
>       await session_manager.get_or_create_session(user_id, initial_data={'first': 'call'})
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'async_generator' object has no attribute 'get_or_create_session'

backend/tests/test_session_manager.py:60: AttributeError
__________________________ test_update_session_atomic __________________________

session_manager = <async_generator object session_manager at 0xfc2402272110>

    @pytest.mark.asyncio
    async def test_update_session_atomic(session_manager):
        """Test atomic session update"""
        user_id = 12345
    
        # Create session
>       await session_manager.get_or_create_session(user_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'async_generator' object has no attribute 'get_or_create_session'

backend/tests/test_session_manager.py:76: AttributeError
__________________ test_update_session_atomic_multiple_fields __________________

session_manager = <async_generator object session_manager at 0xfc2401741e40>

    @pytest.mark.asyncio
    async def test_update_session_atomic_multiple_fields(session_manager):
        """Test updating multiple fields atomically"""
        user_id = 12345
    
>       await session_manager.get_or_create_session(user_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'async_generator' object has no attribute 'get_or_create_session'

backend/tests/test_session_manager.py:95: AttributeError
______________________________ test_clear_session ______________________________

session_manager = <async_generator object session_manager at 0xfc2401741030>

    @pytest.mark.asyncio
    async def test_clear_session(session_manager):
        """Test session deletion"""
        user_id = 12345
    
        # Create session
>       await session_manager.get_or_create_session(user_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'async_generator' object has no attribute 'get_or_create_session'

backend/tests/test_session_manager.py:113: AttributeError
______________________ test_save_completed_label_fallback ______________________

session_manager = <async_generator object session_manager at 0xfc2401740e50>

    @pytest.mark.asyncio
    async def test_save_completed_label_fallback(session_manager):
        """Test save_completed_label with fallback (no replica set)"""
        user_id = 12345
    
        # Create session
>       await session_manager.get_or_create_session(user_id, initial_data={'order_id': 'test123'})
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'async_generator' object has no attribute 'get_or_create_session'

backend/tests/test_session_manager.py:130: AttributeError
_________________________ test_revert_to_previous_step _________________________

session_manager = <async_generator object session_manager at 0xfc240179f3d0>

    @pytest.mark.asyncio
    async def test_revert_to_previous_step(session_manager):
        """Test reverting to previous step"""
        user_id = 12345
    
        # Create session at FROM_ZIP step
>       await session_manager.get_or_create_session(user_id)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: 'async_generator' object has no attribute 'get_or_create_session'

backend/tests/test_session_manager.py:158: AttributeError
_______________________ test_template_database_structure _______________________
async def functions are not natively supported.
You need to install a suitable plugin for your async framework, for example:
  - anyio
  - pytest-asyncio
  - pytest-tornasync
  - pytest-trio
  - pytest-twisted
_________________________ test_template_data_integrity _________________________
async def functions are not natively supported.
You need to install a suitable plugin for your async framework, for example:
  - anyio
  - pytest-asyncio
  - pytest-tornasync
  - pytest-trio
  - pytest-twisted
___________________________ test_admin_notification ____________________________
async def functions are not natively supported.
You need to install a suitable plugin for your async framework, for example:
  - anyio
  - pytest-asyncio
  - pytest-tornasync
  - pytest-trio
  - pytest-twisted
=============================== warnings summary ===============================
../root/.venv/lib/python3.11/site-packages/starlette/formparsers.py:12
  /root/.venv/lib/python3.11/site-packages/starlette/formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

admin_notification_test.py::test_admin_notification_for_label_creation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but admin_notification_test.py::test_admin_notification_for_label_creation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

admin_notification_test.py::test_database_collections
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but admin_notification_test.py::test_database_collections returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

admin_notification_test.py::test_backend_logs_for_notifications
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but admin_notification_test.py::test_backend_logs_for_notifications returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_new_order_flow_basic
  /app/backend/routers/admin/system.py:196: DeprecationWarning: `regex` has been deprecated, please use `pattern` instead
    level: str = Query("ERROR", regex="^(ALL|DEBUG|INFO|WARNING|ERROR|CRITICAL)$"),

backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_new_order_flow_basic
  /app/backend/server.py:6086: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_new_order_flow_basic
backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_new_order_flow_basic
  /root/.venv/lib/python3.11/site-packages/fastapi/applications.py:4495: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_new_order_flow_basic
  /app/backend/server.py:6318: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("shutdown")

backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowEdgeCases::test_missing_user_in_database
  /usr/local/lib/python3.11/unittest/mock.py:2133: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    setattr(_type, entry, MagicProxy(entry, self))
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowEdgeCases::test_blocked_user_attempt
  /usr/local/lib/python3.11/inspect.py:2385: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    parameters.append(Parameter(name, annotation=annotation,
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

backend/tests/integration/test_webhook_integration.py::TestWebhookIntegration::test_telegram_api_rate_limiting
backend/tests/integration/test_webhook_integration.py::TestWebhookIntegration::test_telegram_api_rate_limiting
backend/tests/integration/test_webhook_integration.py::TestWebhookIntegration::test_telegram_api_rate_limiting
backend/tests/integration/test_webhook_integration.py::TestWebhookIntegration::test_telegram_api_rate_limiting
  /root/.venv/lib/python3.11/site-packages/telegram/error.py:244: PTBDeprecationWarning: Deprecated since version v22.2: In a future major version attribute `retry_after` will be of type `datetime.timedelta`. You can opt-in early by setting `PTB_TIMEDELTA=true` or ``PTB_TIMEDELTA=1`` as an environment variable.
    return get_timedelta_value(  # type: ignore[return-value]

backend/tests/test_refactoring_handlers.py::test_telegram_webhook_endpoint
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend/tests/test_refactoring_handlers.py::test_telegram_webhook_endpoint returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend/tests/test_refactoring_handlers.py::test_admin_api_endpoints
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend/tests/test_refactoring_handlers.py::test_admin_api_endpoints returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend/tests/test_refactoring_handlers.py::test_handlers_import_verification
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend/tests/test_refactoring_handlers.py::test_handlers_import_verification returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend/tests/test_refactoring_handlers.py::test_api_health
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend/tests/test_refactoring_handlers.py::test_api_health returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend/tests/test_session_manager.py::test_get_or_create_session_new
  /root/.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_get_or_create_session_new' requested an async fixture 'session_manager', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

backend/tests/test_session_manager.py::test_get_or_create_session_new
  /root/.venv/lib/python3.11/site-packages/pytest_asyncio/plugin.py:673: PytestDeprecationWarning: asyncio test 'test_get_or_create_session_new' requested async @pytest.fixture 'session_manager' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

backend/tests/test_session_manager.py::test_get_or_create_session_existing
  /root/.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_get_or_create_session_existing' requested an async fixture 'session_manager', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

backend/tests/test_session_manager.py::test_get_or_create_session_existing
  /root/.venv/lib/python3.11/site-packages/pytest_asyncio/plugin.py:673: PytestDeprecationWarning: asyncio test 'test_get_or_create_session_existing' requested async @pytest.fixture 'session_manager' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

backend/tests/test_session_manager.py::test_update_session_atomic
  /root/.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_update_session_atomic' requested an async fixture 'session_manager', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

backend/tests/test_session_manager.py::test_update_session_atomic
  /root/.venv/lib/python3.11/site-packages/pytest_asyncio/plugin.py:673: PytestDeprecationWarning: asyncio test 'test_update_session_atomic' requested async @pytest.fixture 'session_manager' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

backend/tests/test_session_manager.py::test_update_session_atomic_multiple_fields
  /root/.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_update_session_atomic_multiple_fields' requested an async fixture 'session_manager', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

backend/tests/test_session_manager.py::test_update_session_atomic_multiple_fields
  /root/.venv/lib/python3.11/site-packages/pytest_asyncio/plugin.py:673: PytestDeprecationWarning: asyncio test 'test_update_session_atomic_multiple_fields' requested async @pytest.fixture 'session_manager' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

backend/tests/test_session_manager.py::test_clear_session
  /root/.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_clear_session' requested an async fixture 'session_manager', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

backend/tests/test_session_manager.py::test_clear_session
  /root/.venv/lib/python3.11/site-packages/pytest_asyncio/plugin.py:673: PytestDeprecationWarning: asyncio test 'test_clear_session' requested async @pytest.fixture 'session_manager' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

backend/tests/test_session_manager.py::test_save_completed_label_fallback
  /root/.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_save_completed_label_fallback' requested an async fixture 'session_manager', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

backend/tests/test_session_manager.py::test_save_completed_label_fallback
  /root/.venv/lib/python3.11/site-packages/pytest_asyncio/plugin.py:673: PytestDeprecationWarning: asyncio test 'test_save_completed_label_fallback' requested async @pytest.fixture 'session_manager' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

backend/tests/test_session_manager.py::test_revert_to_previous_step
  /root/.venv/lib/python3.11/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_revert_to_previous_step' requested an async fixture 'session_manager', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

backend/tests/test_session_manager.py::test_revert_to_previous_step
  /root/.venv/lib/python3.11/site-packages/pytest_asyncio/plugin.py:673: PytestDeprecationWarning: asyncio test 'test_revert_to_previous_step' requested async @pytest.fixture 'session_manager' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

backend_test.py::test_api_health
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_api_health returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_carriers
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_carriers returned <class 'tuple'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_shipstation_production_api_key
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_shipstation_production_api_key returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_shipstation_carrier_ids
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_shipstation_carrier_ids returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_carrier_exclusion_fix
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_carrier_exclusion_fix returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_shipping_rates_production
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_shipping_rates_production returned <class 'tuple'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_shipping_rates
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_shipping_rates returned <class 'tuple'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_bot_infrastructure
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_bot_infrastructure returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_conversation_handler_functions
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_conversation_handler_functions returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_return_to_order_functionality
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_return_to_order_functionality returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_bot_token
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_bot_token returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_search_orders
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_search_orders returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_refund_order
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_refund_order returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_export_csv
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_export_csv returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_telegram_id_environment
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_telegram_id_environment returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_notification_function
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_notification_function returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_contact_admin_buttons
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_contact_admin_buttons returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_backend_admin_id_loading
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_backend_admin_id_loading returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_bot_admin_integration
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_bot_admin_integration returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_state_names_mapping
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_state_names_mapping returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_last_state_assignments
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_last_state_assignments returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_cancel_order_state_handling
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_cancel_order_state_handling returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_return_to_order_state_restoration
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_return_to_order_state_restoration returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_webhook_state_simulation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_webhook_state_simulation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_webhook_endpoint
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_webhook_endpoint returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_bot_commands
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_bot_commands returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_callback_buttons
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_callback_buttons returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_api_endpoints
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_api_endpoints returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_handlers_import_verification
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_handlers_import_verification returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_session_manager_v2_migration
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_session_manager_v2_migration returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_mongodb_ttl_index
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_mongodb_ttl_index returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_mongodb_session_collection
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_mongodb_session_collection returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_session_cleanup_mechanism
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_session_cleanup_mechanism returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_order_creation_session_flow
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_order_creation_session_flow returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_session_cancel_order_cleanup
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_session_cancel_order_cleanup returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_refactoring_handlers_regression
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_refactoring_handlers_regression returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_webhook_status
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_webhook_status returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_webhook_environment_variables
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_webhook_environment_variables returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_webhook_logs_verification
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_webhook_logs_verification returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_double_message_bug_fix
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_double_message_bug_fix returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_template_flow_critical_issue
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_template_flow_critical_issue returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_balance_topup_flow_button_protection
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_balance_topup_flow_button_protection returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_cancel_button_functionality
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_cancel_button_functionality returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_cancel_button_conversation_states
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_cancel_button_conversation_states returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_notification_label_creation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_notification_label_creation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_database_collections
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_database_collections returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_backend_logs_for_notifications
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_backend_logs_for_notifications returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_admin_notification_sending
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_admin_notification_sending returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_help_command_implementation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_help_command_implementation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_bot_help_infrastructure
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_bot_help_infrastructure returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_help_command_url_generation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_help_command_url_generation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_template_based_order_creation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_template_based_order_creation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_check_all_bot_access
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_check_all_bot_access returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_continue_order_after_template_save
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_continue_order_after_template_save returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_template_rename_functionality
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_template_rename_functionality returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_templates_feature_use_template
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_templates_feature_use_template returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_telegram_bot_shipping_rates
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_telegram_bot_shipping_rates returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_help_command_formatting_improvements
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_help_command_formatting_improvements returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_oxapay_order_id_length_fix
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_oxapay_order_id_length_fix returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_oxapay_invoice_creation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_oxapay_invoice_creation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_oxapay_payment_check
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_oxapay_payment_check returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_oxapay_api_configuration
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_oxapay_api_configuration returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_oxapay_webhook_success_message
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_oxapay_webhook_success_message returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

backend_test.py::test_atomic_operations_flow
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but backend_test.py::test_atomic_operations_flow returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

return_to_order_test.py::test_critical_fix
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but return_to_order_test.py::test_critical_fix returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

return_to_order_test.py::test_scenario_simulation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but return_to_order_test.py::test_scenario_simulation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_bot_test.py::test_telegram_bot_status
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_bot_test.py::test_telegram_bot_status returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_bot_test.py::test_telegram_webhook_endpoint
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_bot_test.py::test_telegram_webhook_endpoint returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_bot_test.py::test_telegram_help_command
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_bot_test.py::test_telegram_help_command returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_bot_test.py::test_telegram_callback_buttons
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_bot_test.py::test_telegram_callback_buttons returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_bot_test.py::test_handlers_import
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_bot_test.py::test_handlers_import returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_persistence_test.py::test_redis_persistence_configuration
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_persistence_test.py::test_redis_persistence_configuration returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_persistence_test.py::test_conversation_handler_persistence
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_persistence_test.py::test_conversation_handler_persistence returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_persistence_test.py::test_production_bot_configuration
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_persistence_test.py::test_production_bot_configuration returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_persistence_test.py::test_webhook_vs_polling_mode
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_persistence_test.py::test_webhook_vs_polling_mode returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_persistence_test.py::test_backend_logs_for_persistence
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_persistence_test.py::test_backend_logs_for_persistence returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

telegram_persistence_test.py::test_telegram_bot_infrastructure
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but telegram_persistence_test.py::test_telegram_bot_infrastructure returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

template_test.py::test_conversation_handler_registration
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but template_test.py::test_conversation_handler_registration returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

template_test.py::test_template_function_implementation
  /root/.venv/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but template_test.py::test_template_function_implementation returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_new_order_flow_basic
FAILED backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_template_order_flow
FAILED backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_cancel_order_flow
FAILED backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_data_confirmation_flow
FAILED backend/tests/integration/test_order_flow_e2e.py::TestOrderFlowE2E::test_payment_flow_sufficient_balance
FAILED backend/tests/integration/test_payment_integration.py::TestPaymentIntegration::test_balance_payment_full_flow
FAILED backend/tests/integration/test_payment_integration.py::TestPaymentIntegration::test_insufficient_balance_payment
FAILED backend/tests/integration/test_payment_integration.py::TestPaymentIntegration::test_crypto_payment_invoice_creation
FAILED backend/tests/integration/test_payment_integration.py::TestPaymentIntegration::test_topup_flow
FAILED backend/tests/integration/test_payment_integration.py::TestOrderCreationIntegration::test_complete_order_creation
FAILED backend/tests/integration/test_payment_integration.py::TestOrderCreationIntegration::test_label_generation_after_payment
FAILED backend/tests/integration/test_simple_integration.py::TestDatabaseIntegration::test_order_pagination
FAILED backend/tests/integration/test_simple_integration.py::TestServiceIntegration::test_payment_service_validation
FAILED backend/tests/integration/test_simple_integration.py::TestServiceIntegration::test_template_service_validation
FAILED backend/tests/integration/test_simple_integration.py::TestServiceIntegration::test_shipping_service_validation
FAILED backend/tests/integration/test_simple_integration.py::TestAPIIntegration::test_shipstation_request_building
FAILED backend/tests/integration/test_simple_integration.py::TestAPIIntegration::test_shipstation_api_call_mocked
FAILED backend/tests/integration/test_webhook_integration.py::TestWebhookIntegration::test_telegram_api_rate_limiting
FAILED backend/tests/integration/test_webhook_integration.py::TestExternalAPIIntegration::test_shipstation_api_integration
FAILED backend/tests/integration/test_webhook_integration.py::TestExternalAPIIntegration::test_oxapay_payment_integration
FAILED backend/tests/integration/test_webhook_integration.py::TestExternalAPIIntegration::test_api_timeout_handling
FAILED backend/tests/integration/test_webhook_integration.py::TestExternalAPIIntegration::test_api_error_response_handling
FAILED backend/tests/test_session_manager.py::test_get_or_create_session_new
FAILED backend/tests/test_session_manager.py::test_get_or_create_session_existing
FAILED backend/tests/test_session_manager.py::test_update_session_atomic - At...
FAILED backend/tests/test_session_manager.py::test_update_session_atomic_multiple_fields
FAILED backend/tests/test_session_manager.py::test_clear_session - AttributeE...
FAILED backend/tests/test_session_manager.py::test_save_completed_label_fallback
FAILED backend/tests/test_session_manager.py::test_revert_to_previous_step - ...
FAILED template_test.py::test_template_database_structure - Failed: async def...
FAILED template_test.py::test_template_data_integrity - Failed: async def fun...
FAILED test_admin_notification_direct.py::test_admin_notification - Failed: a...
================ 32 failed, 202 passed, 112 warnings in 32.07s =================).
  - Troubleshoot agent used after agent stuck in loop: NO.
  - Test files created: –î–∞, —Å–æ–∑–¥–∞–Ω—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ,  –∏ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Ç–µ—Å—Ç–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä .
  - Known regressions: –ù–µ—Ç, –Ω–æ –ø–∞–¥–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã –º–æ–≥—É—Ç —Å–∫—Ä—ã–≤–∞—Ç—å —Ä–µ–≥—Ä–µ—Å—Å–∏–∏.

**Credentials to test flow:**
–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è  –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.</analysis>
